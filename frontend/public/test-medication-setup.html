<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨è—¥ç®¡ç†ç³»çµ±è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; }
        h2 { color: #333; font-size: 18px; margin-top: 0; }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç”¨è—¥ç®¡ç†ç³»çµ±è¨ºæ–·å·¥å…·</h1>

    <div class="card">
        <h2>æ­¥é©Ÿ 1: æª¢æŸ¥å¾Œç«¯é€£ç·š</h2>
        <button onclick="checkBackend()">æª¢æŸ¥å¾Œç«¯ API</button>
        <div id="backend-status"></div>
    </div>

    <div class="card">
        <h2>æ­¥é©Ÿ 2: æª¢æŸ¥ç™»å…¥ç‹€æ…‹</h2>
        <button onclick="checkAuth()">æª¢æŸ¥ç™»å…¥</button>
        <div id="auth-status"></div>
    </div>

    <div class="card">
        <h2>æ­¥é©Ÿ 3: æª¢æŸ¥é•·è¼©è³‡æ–™</h2>
        <button onclick="checkElderData()" id="check-elder-btn" disabled>æª¢æŸ¥é•·è¼©è³‡æ–™</button>
        <button onclick="createTestElder()" id="create-elder-btn" disabled>å»ºç«‹æ¸¬è©¦é•·è¼©è³‡æ–™</button>
        <div id="elder-status"></div>
    </div>

    <div class="card">
        <h2>æ­¥é©Ÿ 4: æ¸¬è©¦æ–°å¢è—¥ç‰©</h2>
        <button onclick="testCreateMedication()" id="test-med-btn" disabled>æ¸¬è©¦æ–°å¢è—¥ç‰©</button>
        <div id="medication-status"></div>
    </div>

    <div class="card">
        <h2>å¿«é€Ÿæ“ä½œ</h2>
        <button onclick="window.location.href='login.html'">å‰å¾€ç™»å…¥é é¢</button>
        <button onclick="window.location.href='medications.html'">å‰å¾€ç”¨è—¥ç®¡ç†</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const SUPABASE_URL = 'https://oatdjdelzybcacwqafkk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hdGRqZGVsenliY2Fjd3FhZmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDM5ODUsImV4cCI6MjA3Njc3OTk4NX0.Flk-9yHREG7gWr1etG-TEc2ufPjP-zvW2Ejd2gCqG4w';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentProfile = null;
        let currentElder = null;

        async function checkBackend() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<div class="status info">æª¢æŸ¥ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            âœ… å¾Œç«¯é€£ç·šæ­£å¸¸<br>
                            ç‹€æ…‹: ${data.status}<br>
                            æ™‚é–“: ${data.timestamp}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="status error">âŒ å¾Œç«¯å›æ‡‰ç•°å¸¸: ${response.status}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯<br>éŒ¯èª¤: ${error.message}<br><br>è«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å·²å•Ÿå‹•ï¼ˆnpm startï¼‰</div>`;
            }
        }

        async function checkAuth() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status info">æª¢æŸ¥ä¸­...</div>';

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) throw error;

                if (!session) {
                    statusDiv.innerHTML = `
                        <div class="status warning">
                            âš ï¸ å°šæœªç™»å…¥<br>
                            è«‹å…ˆç™»å…¥å†ä½¿ç”¨ç”¨è—¥ç®¡ç†åŠŸèƒ½
                        </div>
                    `;
                    return;
                }

                currentUser = session.user;

                // æª¢æŸ¥ user_profile
                const { data: profile, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') {
                    throw profileError;
                }

                currentProfile = profile;

                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… å·²ç™»å…¥<br>
                        Email: ${currentUser.email}<br>
                        User ID: ${currentUser.id}
                        ${profile ? `<br>Profile ID: ${profile.id}<br>è§’è‰²: ${profile.role || 'æœªè¨­å®š'}` : '<br><span style="color: orange;">âš ï¸ æœªå»ºç«‹ Profile</span>'}
                    </div>
                    <pre>${JSON.stringify({ user: currentUser, profile }, null, 2)}</pre>
                `;

                // å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
                document.getElementById('check-elder-btn').disabled = false;
                document.getElementById('create-elder-btn').disabled = false;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æª¢æŸ¥ç™»å…¥å¤±æ•—<br>éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function checkElderData() {
            const statusDiv = document.getElementById('elder-status');
            statusDiv.innerHTML = '<div class="status info">æª¢æŸ¥ä¸­...</div>';

            if (!currentProfile) {
                statusDiv.innerHTML = '<div class="status error">âŒ è«‹å…ˆåŸ·è¡Œæ­¥é©Ÿ 2: æª¢æŸ¥ç™»å…¥</div>';
                return;
            }

            try {
                const { data: elder, error } = await supabaseClient
                    .from('elders')
                    .select('*')
                    .eq('user_profile_id', currentProfile.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (!elder) {
                    statusDiv.innerHTML = `
                        <div class="status warning">
                            âš ï¸ æ²’æœ‰é•·è¼©è³‡æ–™<br>
                            è«‹é»æ“Šã€Œå»ºç«‹æ¸¬è©¦é•·è¼©è³‡æ–™ã€æŒ‰éˆ•
                        </div>
                    `;
                    return;
                }

                currentElder = elder;

                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… æ‰¾åˆ°é•·è¼©è³‡æ–™<br>
                        é•·è¼© ID: ${elder.id}<br>
                        å§“å: ${elder.name}<br>
                        Email: ${elder.email || 'æœªè¨­å®š'}<br>
                        ç”Ÿæ—¥: ${elder.birth_date || 'æœªè¨­å®š'}
                    </div>
                    <pre>${JSON.stringify(elder, null, 2)}</pre>
                `;

                // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
                document.getElementById('test-med-btn').disabled = false;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æª¢æŸ¥é•·è¼©è³‡æ–™å¤±æ•—<br>éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function createTestElder() {
            const statusDiv = document.getElementById('elder-status');
            statusDiv.innerHTML = '<div class="status info">å»ºç«‹ä¸­...</div>';

            if (!currentProfile) {
                statusDiv.innerHTML = '<div class="status error">âŒ è«‹å…ˆåŸ·è¡Œæ­¥é©Ÿ 2: æª¢æŸ¥ç™»å…¥</div>';
                return;
            }

            try {
                // å…ˆæ›´æ–° profile çš„ role
                await supabaseClient
                    .from('user_profiles')
                    .update({ role: 'elder' })
                    .eq('id', currentProfile.id);

                // å»ºç«‹é•·è¼©è³‡æ–™ï¼ˆåŒ…å« auth_user_idï¼‰
                const { data: elder, error } = await supabaseClient
                    .from('elders')
                    .insert({
                        auth_user_id: currentUser.id,
                        user_profile_id: currentProfile.id,
                        name: 'æ¸¬è©¦é•·è¼©',
                        birth_date: '1950-01-01',
                        email: currentUser.email
                    })
                    .select()
                    .single();

                if (error) throw error;

                currentElder = elder;

                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… æ¸¬è©¦é•·è¼©è³‡æ–™å»ºç«‹æˆåŠŸï¼<br>
                        é•·è¼© ID: ${elder.id}<br>
                        å§“å: ${elder.name}<br>
                        Email: ${elder.email}
                    </div>
                    <pre>${JSON.stringify(elder, null, 2)}</pre>
                `;

                // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
                document.getElementById('test-med-btn').disabled = false;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ å»ºç«‹é•·è¼©è³‡æ–™å¤±æ•—<br>éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function testCreateMedication() {
            const statusDiv = document.getElementById('medication-status');
            statusDiv.innerHTML = '<div class="status info">æ¸¬è©¦ä¸­...</div>';

            if (!currentElder) {
                statusDiv.innerHTML = '<div class="status error">âŒ è«‹å…ˆåŸ·è¡Œæ­¥é©Ÿ 3: æª¢æŸ¥é•·è¼©è³‡æ–™</div>';
                return;
            }

            try {
                const testMedication = {
                    elder_id: currentElder.id,
                    medication_name: 'æ¸¬è©¦ç”¨é™è¡€å£“è—¥',
                    dosage: '5mg, 1é¡†',
                    frequency: 'daily',
                    time_of_day: 'morning',
                    start_date: new Date().toISOString().split('T')[0],
                    instructions: 'é£¯å¾Œæœç”¨ï¼Œå¤šå–æ°´',
                    status: 'active'
                };

                const response = await fetch(`${API_BASE_URL}/api/medications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testMedication)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'æ–°å¢å¤±æ•—');
                }

                statusDiv.innerHTML = `
                    <div class="status success">
                        âœ… æ¸¬è©¦è—¥ç‰©æ–°å¢æˆåŠŸï¼<br>
                        è—¥ç‰© ID: ${result.data.id}<br>
                        è—¥ç‰©åç¨±: ${result.data.medication_name}<br>
                        <br>
                        ç¾åœ¨å¯ä»¥å‰å¾€ç”¨è—¥ç®¡ç†é é¢è¨­å®šæé†’æ™‚é–“äº†ï¼
                    </div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æ¸¬è©¦æ–°å¢è—¥ç‰©å¤±æ•—<br>éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œæª¢æŸ¥
        window.onload = async () => {
            await checkBackend();
        };
    </script>
</body>
</html>
