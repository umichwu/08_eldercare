<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="好友聊天與生活分享">
    <meta name="theme-color" content="#FFB74D">
    <title>好友聊天 - ElderCare</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Styles -->
    <link rel="stylesheet" href="social.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 頂部導航欄 -->
    <header class="social-header">
        <button class="header-back-btn" onclick="window.location.href='index.html'">
            <span class="back-arrow">←</span>
            <span>返回</span>
        </button>
        <h1 class="header-title">
            <span class="header-icon">💬</span>
            好友聊天
        </h1>
        <div class="header-actions">
            <button class="header-btn" onclick="showNotifications()" title="通知">
                <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
                🔔
            </button>
            <button class="header-btn" onclick="showAddFriendModal()" title="加好友">
                ➕
            </button>
        </div>
    </header>

    <!-- 主要內容區 - 左右分欄架構 -->
    <div class="social-main-container">
        <!-- 左側：好友列表 -->
        <aside class="friends-sidebar">
            <!-- 搜尋框 -->
            <div class="sidebar-search">
                <input type="text"
                       id="friendSearchInput"
                       class="search-input"
                       placeholder="🔍 搜尋好友..."
                       oninput="filterFriends(event)">
            </div>

            <!-- 好友列表 -->
            <div class="friends-list" id="friendsList">
                <!-- 載入中 -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入好友列表中...</p>
                </div>
            </div>

            <!-- 無好友提示 -->
            <div id="noFriendsPlaceholder" class="empty-state" style="display: none;">
                <div class="empty-icon">👥</div>
                <h3>還沒有好友</h3>
                <p>開始加好友，分享生活吧！</p>
                <button class="btn-primary" onclick="showAddFriendModal()">
                    ➕ 加好友
                </button>
            </div>
        </aside>

        <!-- 右側：內容區域 -->
        <main class="content-area">
            <!-- 未選擇好友的歡迎畫面 -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">💬</div>
                    <h2>歡迎來到好友聊天</h2>
                    <p class="welcome-text">選擇左側的好友開始聊天，或查看動態時間軸</p>
                    <div class="welcome-quick-actions">
                        <button class="quick-action-btn" onclick="showAddFriendModal()">
                            <span class="action-icon">➕</span>
                            <span>加好友</span>
                        </button>
                        <button class="quick-action-btn" onclick="switchToTimeline()">
                            <span class="action-icon">📰</span>
                            <span>查看動態</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 選中好友後的內容區 -->
            <div id="friendContentArea" class="friend-content-area" style="display: none;">
                <!-- 好友資訊 Header -->
                <div class="friend-header">
                    <div class="friend-header-info">
                        <img id="selectedFriendAvatar" class="friend-header-avatar" src="" alt="頭像">
                        <div class="friend-header-text">
                            <h2 id="selectedFriendName" class="friend-header-name"></h2>
                            <span id="selectedFriendStatus" class="friend-header-status">線上</span>
                        </div>
                    </div>
                    <div class="friend-header-actions">
                        <button class="header-action-btn" onclick="startVideoCall()" title="視訊通話">
                            📹
                        </button>
                        <button class="header-action-btn" onclick="startVoiceCall()" title="語音通話">
                            📞
                        </button>
                    </div>
                </div>

                <!-- 內容切換 Tab -->
                <div class="content-tabs">
                    <button class="content-tab active" data-tab="chat" onclick="switchContentTab('chat')">
                        💬 聊天
                    </button>
                    <button class="content-tab" data-tab="posts" onclick="switchContentTab('posts')">
                        📰 動態
                    </button>
                </div>

                <!-- 聊天內容 -->
                <div id="chatContent" class="tab-panel active">
                    <!-- 聊天訊息區域 -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-date-divider">
                            <span>今天</span>
                        </div>
                        <!-- 訊息會動態載入在這裡 -->
                    </div>

                    <!-- 輸入區域 -->
                    <div class="chat-input-area">
                        <button class="input-action-btn" onclick="showEmojiPicker()" title="表情符號">
                            😊
                        </button>
                        <button class="input-action-btn" onclick="selectImage()" title="圖片">
                            📷
                        </button>
                        <input type="text"
                               id="chatInput"
                               class="chat-input"
                               placeholder="輸入訊息..."
                               onkeypress="handleChatKeyPress(event)">
                        <button class="send-btn" onclick="sendMessage()">
                            <span class="send-icon">📤</span>
                            發送
                        </button>
                    </div>
                </div>

                <!-- 動態內容 -->
                <div id="postsContent" class="tab-panel" style="display: none;">
                    <!-- 好友的動態列表 -->
                    <div class="friend-posts-list" id="friendPostsList">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>載入動態中...</p>
                        </div>
                    </div>

                    <!-- 無動態提示 -->
                    <div id="noPostsPlaceholder" class="empty-state" style="display: none;">
                        <div class="empty-icon">📝</div>
                        <h3>還沒有動態</h3>
                        <p>這位好友還沒有發布任何動態</p>
                    </div>
                </div>
            </div>

            <!-- 動態時間軸（所有好友） -->
            <div id="timelineArea" class="timeline-area" style="display: none;">
                <!-- 時間軸 Header -->
                <div class="timeline-header">
                    <h2 class="timeline-title">
                        <span class="timeline-icon">📰</span>
                        動態時間軸
                    </h2>
                    <button class="btn-primary" onclick="openPostModal()">
                        ✏️ 發布動態
                    </button>
                </div>

                <!-- 快速發文 -->
                <div class="quick-post-card">
                    <div class="quick-post-header">
                        <img id="userAvatarPost" class="user-avatar" src="" alt="頭像">
                        <input type="text"
                               class="quick-post-input"
                               placeholder="分享您的生活點滴..."
                               readonly
                               onclick="openPostModal()">
                    </div>
                    <div class="quick-post-actions">
                        <button class="post-action-btn" onclick="openPostModal('photo')">
                            📷 照片
                        </button>
                        <button class="post-action-btn" onclick="openPostModal('mood')">
                            😊 心情
                        </button>
                        <button class="post-action-btn" onclick="openPostModal('location')">
                            📍 位置
                        </button>
                    </div>
                </div>

                <!-- 動態列表 -->
                <div id="timelineList" class="timeline-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入動態中...</p>
                    </div>
                </div>

                <!-- 無動態提示 -->
                <div id="noTimelinePostsPlaceholder" class="empty-state" style="display: none;">
                    <div class="empty-icon">📝</div>
                    <h3>還沒有動態</h3>
                    <p>開始分享您的生活吧！</p>
                    <button class="btn-primary" onclick="openPostModal()">
                        ✏️ 發布第一則動態
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 發文 Modal -->
    <div id="postModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>📝 發布動態</h3>
                <button class="modal-close" onclick="closePostModal()">✕</button>
            </div>
            <div class="modal-body">
                <textarea id="postContent"
                          class="post-textarea"
                          placeholder="分享您的生活點滴..."
                          rows="5"></textarea>

                <!-- 圖片預覽區域 -->
                <div id="imagePreview" class="image-preview-container" style="margin-top: 12px;"></div>

                <div class="post-options">
                    <div class="post-option">
                        <label>心情</label>
                        <select id="postMood" class="mood-select">
                            <option value="">選擇心情</option>
                            <option value="happy">😊 開心</option>
                            <option value="excited">🎉 興奮</option>
                            <option value="relaxed">😌 放鬆</option>
                            <option value="grateful">🙏 感恩</option>
                            <option value="thoughtful">🤔 若有所思</option>
                            <option value="sad">😢 難過</option>
                        </select>
                    </div>

                    <div class="post-option">
                        <label>可見範圍</label>
                        <select id="postVisibility" class="visibility-select">
                            <option value="friends">👥 好友</option>
                            <option value="public">🌍 公開</option>
                            <option value="private">🔒 私密</option>
                        </select>
                    </div>
                </div>

                <!-- 圖片上傳按鈕 (隱藏) -->
                <input type="file" id="postImage" accept="image/*" style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePostModal()">取消</button>
                <button class="btn-primary" onclick="publishPost()">發布</button>
            </div>
        </div>
    </div>

    <!-- 加好友 Modal -->
    <div id="addFriendModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ 加好友</h3>
                <button class="modal-close" onclick="closeAddFriendModal()">✕</button>
            </div>
            <div class="modal-body">
                <input type="text"
                       id="friendSearchInput"
                       class="search-input-large"
                       placeholder="搜尋姓名、Email 或電話..."
                       oninput="searchUsers(event)">

                <div id="searchResults" class="search-results">
                    <!-- 搜尋結果會顯示在這裡 -->
                </div>

                <div class="modal-divider"></div>

                <h4>好友邀請</h4>
                <div id="friendRequests" class="friend-requests-list">
                    <!-- 好友邀請會顯示在這裡 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 通知 Modal -->
    <div id="notificationsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔔 通知</h3>
                <button class="modal-close" onclick="closeNotificationsModal()">✕</button>
            </div>
            <div class="modal-body">
                <div id="notificationsList" class="notifications-list">
                    <!-- 通知會顯示在這裡 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 載入提示 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>處理中...</p>
        </div>
    </div>

    <!-- 通話視窗 -->
    <div id="callModal" class="call-modal" style="display: none;">
        <div class="call-container">
            <!-- 通話狀態標題 -->
            <div class="call-header">
                <h3 id="callStatus" class="call-status">連線中...</h3>
                <button class="call-close-btn" onclick="endCall()" title="結束通話">✕</button>
            </div>

            <!-- 視訊區域 -->
            <div class="call-video-area">
                <!-- 對方的視訊 -->
                <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                <!-- 自己的視訊（小視窗） -->
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>

                <!-- 無視訊時的頭像顯示 -->
                <div id="remoteAvatar" class="call-avatar remote-avatar" style="display: none;">
                    <img id="remoteAvatarImg" src="" alt="對方頭像">
                    <p id="remoteName" class="call-name"></p>
                </div>
                <div id="localAvatar" class="call-avatar local-avatar" style="display: none;">
                    <img id="localAvatarImg" src="" alt="我的頭像">
                    <p class="call-name">我</p>
                </div>
            </div>

            <!-- 通話時長 -->
            <div class="call-duration">
                <span id="callTimer">00:00</span>
            </div>

            <!-- 控制按鈕 -->
            <div class="call-controls">
                <button id="toggleMicBtn" class="call-control-btn" onclick="toggleMic()" title="靜音/取消靜音">
                    <span id="micIcon">🎤</span>
                </button>
                <button id="toggleVideoBtn" class="call-control-btn" onclick="toggleVideo()" title="開啟/關閉視訊" style="display: none;">
                    <span id="videoIcon">📹</span>
                </button>
                <button class="call-control-btn end-call-btn" onclick="endCall()" title="結束通話">
                    <span>📞</span>
                    <span class="btn-text">結束</span>
                </button>
                <button id="switchCameraBtn" class="call-control-btn" onclick="switchCamera()" title="切換鏡頭" style="display: none;">
                    <span>🔄</span>
                </button>
            </div>
        </div>

        <!-- 來電通知 -->
        <div id="incomingCallAlert" class="incoming-call-alert" style="display: none;">
            <div class="incoming-call-content">
                <img id="incomingCallerAvatar" class="incoming-caller-avatar" src="" alt="來電者">
                <h3 id="incomingCallerName" class="incoming-caller-name"></h3>
                <p id="incomingCallType" class="incoming-call-type"></p>
                <div class="incoming-call-actions">
                    <button class="incoming-call-btn accept-btn" onclick="acceptCall()">
                        <span>📞</span>
                        <span>接聽</span>
                    </button>
                    <button class="incoming-call-btn reject-btn" onclick="rejectCall()">
                        <span>✕</span>
                        <span>拒絕</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="social.js"></script>
</body>
</html>
