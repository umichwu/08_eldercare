<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AIé©…å‹•çš„é•·è¼©é™ªä¼´èŠå¤©ç³»çµ±">
    <meta name="theme-color" content="#667eea">
    <title>é•·è¼©é™ªä¼´åŠ©æ‰‹ - ElderCare Companion</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Styles - Modern Design -->
    <link rel="stylesheet" href="styles-modern.css">
    <!-- Fallback to old styles -->
    <!-- <link rel="stylesheet" href="styles.css"> -->

    <!-- åˆå§‹è¼‰å…¥æ¨£å¼ - é˜²æ­¢ç™½å±/é»‘å± -->
    <style>
        /* åˆå§‹è¼‰å…¥ç•«é¢ */
        #initialLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0A0A0F 0%, #1E1E24 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease-out;
        }

        #initialLoader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-logo {
            font-size: 64px;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .loader-text {
            color: #E8EAED;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 32px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(10, 132, 255, 0.2);
            border-top-color: #0A84FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* ç¢ºä¿ app åœ¨è¼‰å…¥æ™‚ä¸é¡¯ç¤º */
        #app {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        #app.loaded {
            opacity: 1;
        }
    </style>

    <!-- è£ç½®åµæ¸¬èˆ‡è¡Œå‹•ç‰ˆæ¨£å¼ - Modern -->
    <link rel="stylesheet" href="mobile-modern.css">
    <!-- Old mobile styles -->
    <!-- <link rel="stylesheet" href="mobile.css"> -->
    <script src="device-detector.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- å…¨åŸŸå¿«æ·éµ -->
    <script src="keyboard-shortcuts.js"></script>

    <!-- éºµåŒ…å±‘å°èˆª -->
    <script src="breadcrumb-navigation.js"></script>
</head>
<body>
    <!-- åˆå§‹è¼‰å…¥ç•«é¢ -->
    <div id="initialLoader">
        <div class="loader-logo">ğŸ¥</div>
        <div class="loader-text">é•·è¼©é™ªä¼´åŠ©æ‰‹</div>
        <div class="loader-spinner"></div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app">
        <!-- é ­éƒ¨å€åŸŸ -->
        <header class="app-header">
            <!-- è¡Œå‹•ç‰ˆæ¼¢å ¡é¸å–®æŒ‰éˆ• -->
            <button id="mobileMenuBtn" class="mobile-menu-btn" title="é¸å–®">
                â˜°
            </button>
            <h1 class="app-title" data-i18n="app.title">ğŸ¥ é•·è¼©é™ªä¼´åŠ©æ‰‹</h1>
            <div class="header-controls">
                <!-- ä½¿ç”¨è€…è³‡è¨Š -->
                <div id="userInfo" class="user-info" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="" alt="é ­åƒ">
                    <span id="userName" class="user-name"></span>
                </div>

                <button id="voiceToggle" class="icon-btn" data-i18n-title="header.voiceToggle" title="é»æ“Šé—œé–‰èªéŸ³">
                    ğŸ”Š
                </button>
                <button id="settingsBtn" class="icon-btn" data-i18n-title="header.settings" title="è¨­å®š">
                    âš™ï¸
                </button>
                <button id="logoutBtn" class="icon-btn" data-i18n-title="header.logout" title="ç™»å‡º" style="display: none;">
                    ğŸšª
                </button>
            </div>
        </header>

        <!-- å´é‚Šæ¬„é®ç½©ï¼ˆç”¨æ–¼è¡Œå‹•ç‰ˆï¼‰ -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="app-main">
            <!-- å·¦å´ï¼šå°è©±åˆ—è¡¨ -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 data-i18n="sidebar.title">å°è©±è¨˜éŒ„</h2>
                    <button id="newChatBtn" class="btn btn-primary" data-i18n="sidebar.newChat">
                        â• æ–°å°è©±
                    </button>
                </div>
                <div id="conversationList" class="conversation-list">
                    <!-- å‹•æ…‹è¼‰å…¥å°è©±åˆ—è¡¨ -->
                </div>
            </aside>

            <!-- ä¸­é–“ï¼šèŠå¤©å€åŸŸ -->
            <section class="chat-container">
                <!-- æ­¡è¿ç•«é¢ -->
                <div id="welcomeScreen" class="welcome-screen">
                    <div class="welcome-content">
                        <h2 class="welcome-title" data-i18n="welcome.title">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„é™ªä¼´åŠ©æ‰‹ ğŸ˜Š</h2>
                        <p class="welcome-subtitle" data-i18n="welcome.subtitle">æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ</p>

                        <!-- å¿«é€ŸåŠŸèƒ½æŒ‰éˆ•ï¼ˆè¡Œå‹•ç‰ˆï¼‰ -->
                        <button id="quickFunctionsBtn" class="quick-functions-btn mobile-only">
                            âš¡ å¿«é€ŸåŠŸèƒ½
                        </button>
                    </div>
                </div>

                <!-- èŠå¤©è¨Šæ¯å€ -->
                <div id="chatMessages" class="chat-messages">
                    <!-- å‹•æ…‹è¼‰å…¥è¨Šæ¯ -->
                </div>

                <!-- è¼¸å…¥å€åŸŸ -->
                <div class="input-container">
                    <!-- è¨Šæ¯è¼¸å…¥æ¡† -->
                    <div class="input-wrapper">
                        <textarea
                            id="messageInput"
                            class="message-input"
                            placeholder="è«‹è¼¸å…¥è¨Šæ¯..."
                            rows="2"
                        ></textarea>
                        <div class="input-controls">
                            <button id="voiceInputBtn" class="btn btn-voice" data-i18n="input.voiceInput">
                                ğŸ¤ èªéŸ³è¼¸å…¥
                            </button>
                            <button id="sendBtn" class="btn btn-send" data-i18n="input.send">
                                â¤ å‚³é€
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å³å´ï¼šç¸½çµå’Œè³‡è¨Š -->
            <aside class="info-panel">
                <!-- å¿«é€ŸåŠŸèƒ½æŒ‰éˆ•å€ -->
                <div class="panel-section quick-functions-panel">
                    <h3>âš¡ å¿«é€ŸåŠŸèƒ½</h3>
                    <div class="quick-actions-sidebar">
                        <!-- ç·Šæ€¥æ±‚åŠ©æŒ‰éˆ•ï¼ˆç½®é ‚ï¼Œç´…è‰²è­¦ç¤ºï¼‰ -->
                        <button id="sosBtn" class="quick-btn-sidebar sos-btn-sidebar" data-i18n="input.sos" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-weight: bold; border: 2px solid #c0392b;">
                            ğŸ†˜ ç·Šæ€¥æ±‚åŠ©
                        </button>

                        <button class="quick-btn-sidebar" data-message="ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ" data-i18n="quickAction.weather">
                            â˜€ï¸ å¤©æ°£æŸ¥è©¢
                        </button>
                        <button class="quick-btn-sidebar" onclick="window.location.href='medications.html'" data-i18n="quickAction.medication">
                            ğŸ’Š ç”¨è—¥ç®¡ç†
                        </button>
                        <button class="quick-btn-sidebar" onclick="window.location.href='daily-reminders.html'" data-i18n="quickAction.dailyReminders">
                            ğŸ“… ç”Ÿæ´»æé†’
                        </button>
                        <button class="quick-btn-sidebar" onclick="window.location.href='family-dashboard.html'" data-i18n="quickAction.familyDashboard">
                            ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å±¬ç›£æ§
                        </button>
                        <button class="quick-btn-sidebar" onclick="window.location.href='social.html'" data-i18n="quickAction.social">
                            ğŸ’¬ å¥½å‹èŠå¤©
                        </button>
                        <button class="quick-btn-sidebar" onclick="window.location.href='group-chat.html'" data-i18n="quickAction.groupChat">
                            ğŸ‘¥ ç¾¤çµ„èŠå¤©
                        </button>
                        <button class="quick-btn-sidebar" data-message="æˆ‘è¦ºå¾—æœ‰é»ä¸èˆ’æœ" data-i18n="quickAction.health">
                            ğŸ¥ å¥åº·è«®è©¢
                        </button>
                    </div>
                </div>

                <div class="panel-section">
                    <h3 data-i18n="panel.summary">ğŸ’¡ å°è©±æ‘˜è¦</h3>
                    <div id="summaryContent" class="summary-content">
                        <p class="empty-state" data-i18n="panel.emptySummary">å°šç„¡å°è©±æ‘˜è¦</p>
                    </div>
                    <button id="generateSummaryBtn" class="btn btn-secondary" style="display: none;" data-i18n="panel.generateSummary">
                        ç”¢ç”Ÿæ‘˜è¦
                    </button>
                </div>

                <div class="panel-section">
                    <h3 data-i18n="panel.statistics">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-label" data-i18n="panel.totalMessages">è¨Šæ¯æ•¸é‡</span>
                            <span id="messageCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-i18n="panel.untilSummary">è·é›¢ç¸½çµ</span>
                            <span id="summaryProgress" class="stat-value">0/20</span>
                        </div>
                    </div>
                </div>

                <!-- èª¿è©¦é¢æ¿ -->
                <div class="panel-section" style="background: #f0f8ff; border: 2px solid #4a90e2;">
                    <h3>ğŸ” ç³»çµ±ç‹€æ…‹ (èª¿è©¦æ¨¡å¼)</h3>
                    <div class="debug-info" style="font-size: 12px; font-family: monospace;">
                        <div style="margin: 5px 0;">
                            <strong>ä½¿ç”¨è€… ID:</strong>
                            <span id="debugUserId" style="color: #d63031;">æœªåˆå§‹åŒ–</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>ç•¶å‰å°è©±:</strong>
                            <span id="debugConversation" style="color: #d63031;">ç„¡</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>æ‡‰ç”¨ç‹€æ…‹:</strong>
                            <span id="debugAppStatus" style="color: #d63031;">æœªåˆå§‹åŒ–</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>æŒ‰éˆ•ç¶å®š:</strong>
                            <span id="debugButtonStatus" style="color: #d63031;">æœªç¶å®š</span>
                        </div>
                        <div style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #ddd;">
                            <button onclick="testSendButton()" class="btn btn-secondary" style="width: 100%; font-size: 14px;">
                                ğŸ§ª æ¸¬è©¦å‚³é€æŒ‰éˆ•
                            </button>
                        </div>
                        <div style="margin: 10px 0;">
                            <button onclick="showConsoleInstructions()" class="btn btn-secondary" style="width: 100%; font-size: 14px;">
                                ğŸ“‹ å¦‚ä½•æŸ¥çœ‹ Console
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç¶²è·¯æœå°‹è¨­å®š -->
                <div class="panel-section" style="background: #fff3cd; border: 2px solid #ffc107;">
                    <h3>ğŸ” ç¶²è·¯æœå°‹è¨­å®š</h3>
                    <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        <p style="margin: 5px 0;">é–‹å•Ÿå¾Œï¼ŒAI æœƒåœ¨å›ç­”å³æ™‚è³‡è¨Šï¼ˆå¤©æ°£ã€æ–°èç­‰ï¼‰æ™‚æä¾›æ›´æº–ç¢ºçš„æŒ‡å¼•ã€‚</p>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">ğŸŒ</span>
                            <div>
                                <div style="font-weight: 600; font-size: 14px;">ç¶²è·¯æœå°‹</div>
                                <div id="webSearchStatus" style="font-size: 12px; color: #28a745;">å·²å•Ÿç”¨</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="webSearchToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <strong>èªªæ˜ï¼š</strong>é—œé–‰å¾Œï¼ŒAI å°‡èª å¯¦å‘ŠçŸ¥ç„¡æ³•æŸ¥è©¢å³æ™‚è³‡è¨Šï¼Œä¸¦å¼•å°æ‚¨åˆ°æ­£ç¢ºçš„è³‡è¨Šä¾†æºã€‚
                    </div>
                </div>
            </aside>
        </main>

        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text">æ€è€ƒä¸­...</p>
        </div>

        <!-- SOS ç¢ºèªå°è©±æ¡† -->
        <div id="sosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="modal-title">ğŸ†˜ ç·Šæ€¥æ±‚åŠ©</h2>
                <p class="modal-text">ç¢ºå®šè¦ç™¼é€ç·Šæ€¥é€šçŸ¥çµ¦å®¶äººå—ï¼Ÿ</p>
                <div class="modal-actions">
                    <button id="sosConfirmBtn" class="btn btn-danger">
                        ç¢ºèªç™¼é€
                    </button>
                    <button id="sosCancelBtn" class="btn btn-secondary">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- å¿«é€ŸåŠŸèƒ½é¸å–®ï¼ˆè¡Œå‹•ç‰ˆï¼‰ -->
        <div id="quickFunctionsModal" class="modal quick-functions-modal" style="display: none;">
            <div class="modal-content quick-functions-content">
                <h2 class="modal-title">âš¡ å¿«é€ŸåŠŸèƒ½</h2>
                <div class="quick-functions-list">
                    <!-- ç·Šæ€¥æ±‚åŠ©æŒ‰éˆ•ï¼ˆç½®é ‚ï¼Œç´…è‰²è­¦ç¤ºï¼‰ -->
                    <button class="quick-function-item" id="sosQuickBtn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-weight: bold; border: 2px solid #c0392b;">
                        <span class="quick-icon">ğŸ†˜</span>
                        <span class="quick-text">ç·Šæ€¥æ±‚åŠ©</span>
                    </button>

                    <button class="quick-function-item" data-message="ä»Šå¤©å¤©æ°£å¦‚ä½•ï¼Ÿ">
                        <span class="quick-icon">â˜€ï¸</span>
                        <span class="quick-text">å¤©æ°£æŸ¥è©¢</span>
                    </button>
                    <button class="quick-function-item" onclick="window.location.href='medications.html'">
                        <span class="quick-icon">ğŸ’Š</span>
                        <span class="quick-text">ç”¨è—¥ç®¡ç†</span>
                    </button>
                    <button class="quick-function-item" onclick="window.location.href='daily-reminders.html'">
                        <span class="quick-icon">ğŸ“…</span>
                        <span class="quick-text">ç”Ÿæ´»æé†’</span>
                    </button>
                    <button class="quick-function-item" onclick="window.location.href='family-dashboard.html'">
                        <span class="quick-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                        <span class="quick-text">å®¶å±¬ç›£æ§</span>
                    </button>
                    <button class="quick-function-item" onclick="window.location.href='social.html'">
                        <span class="quick-icon">ğŸ’¬</span>
                        <span class="quick-text">å¥½å‹èŠå¤©</span>
                    </button>
                    <button class="quick-function-item" onclick="window.location.href='group-chat.html'">
                        <span class="quick-icon">ğŸ‘¥</span>
                        <span class="quick-text">ç¾¤çµ„èŠå¤©</span>
                    </button>
                    <button class="quick-function-item" data-message="æˆ‘è¦ºå¾—æœ‰é»ä¸èˆ’æœ">
                        <span class="quick-icon">ğŸ¥</span>
                        <span class="quick-text">å¥åº·è«®è©¢</span>
                    </button>
                </div>
                <button id="closeQuickFunctionsBtn" class="btn btn-secondary">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===================================
        // è£ç½®åµæ¸¬åˆå§‹åŒ– - æœ€å„ªå…ˆåŸ·è¡Œ
        // ===================================

        // åˆå§‹åŒ–è£ç½®åµæ¸¬å’Œ UI é©é…
        // æ³¨æ„ï¼šåœ¨ä¸»æ‡‰ç”¨é é¢ï¼Œæˆ‘å€‘åªéœ€è¦æª¢æ¸¬è£ç½®é¡å‹ï¼Œä¸éœ€è¦è™•ç† LINE ç€è¦½å™¨
        // ï¼ˆå› ç‚º OAuth èªè­‰å·²ç¶“åœ¨ login.html å®Œæˆï¼‰
        initDeviceDetection({
            checkLINE: false,       // ä¸»æ‡‰ç”¨ä¸éœ€è¦æª¢æŸ¥ LINEï¼ˆèªè­‰å·²å®Œæˆï¼‰
            autoRedirect: false,    // ä¸éœ€è¦é‡å°å‘
            loadMobileCSS: true,    // è¼‰å…¥è¡Œå‹•ç‰ˆ CSS
            logDeviceInfo: true     // è¼¸å‡ºè£ç½®è³‡è¨Šåˆ° console
        });

        // è¼¸å‡ºè£ç½®é¡å‹ä¾›æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨
        const DEVICE_TYPE = DeviceDetector.getDeviceType();
        const IS_MOBILE = DeviceDetector.isMobile();
        console.log(`ğŸ“± ç•¶å‰è£ç½®é¡å‹: ${DEVICE_TYPE}, è¡Œå‹•è£ç½®: ${IS_MOBILE}`);

        // ===================================
        // PWA Service Worker Registration
        // ===================================
        // æš«æ™‚ç¦ç”¨ Service Worker ä»¥è¨ºæ–·å•é¡Œ
        console.log('âš ï¸ Service Worker å·²æš«æ™‚ç¦ç”¨ï¼Œç”¨æ–¼è¨ºæ–·å•é¡Œ');
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('ğŸ”„ New Service Worker found, installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New service worker available, but don't auto-reload
                                        console.log('âœ¨ New version available! Reload to update.');
                                        // Optional: Show a subtle notification to user
                                        // For now, just log it to avoid infinite reload
                                    } else {
                                        // First time install
                                        console.log('âœ… Service Worker installed for the first time');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('âŒ Service Worker registration failed:', error);
                    });
            });

            // Handle service worker updates - removed auto-reload to prevent infinite loop
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    console.log('ğŸ”„ Service Worker controller changed');
                    // Don't auto-reload, let user decide
                    // window.location.reload();
                }
            });
        }
        */

        // ===================================
        // PWA Install Prompt
        // ===================================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button (you can add this to UI later)
            console.log('ğŸ’¡ PWA installation available');
        });

        // ===================================
        // Authentication Check
        // ===================================
        const SUPABASE_URL = 'https://oatdjdelzybcacwqafkk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hdGRqZGVsenliY2Fjd3FhZmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDM5ODUsImV4cCI6MjA3Njc3OTk4NX0.Flk-9yHREG7gWr1etG-TEc2ufPjP-zvW2Ejd2gCqG4w';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global user info
        let currentUser = null;
        let userProfile = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                console.log('ğŸ” é–‹å§‹æª¢æŸ¥èªè­‰...');
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('âŒ Auth check error:', error);
                    alert('èªè­‰æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
                    redirectToLogin();
                    return false;
                }

                if (!session) {
                    console.log('âš ï¸ No active session, redirecting to login...');
                    redirectToLogin();
                    return false;
                }

                currentUser = session.user;
                console.log('âœ… User authenticated:', currentUser.email);
                console.log('ğŸ‘¤ User ID:', currentUser.id);

                // Load user profile
                console.log('ğŸ“¥ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...');
                const profileLoaded = await loadUserProfile();

                if (!profileLoaded) {
                    console.error('âŒ ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
                    alert('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥');
                    return false;
                }

                // Display user info
                displayUserInfo();

                console.log('âœ… èªè­‰æª¢æŸ¥å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ Auth check failed:', error);
                alert('ç³»çµ±éŒ¯èª¤ï¼š' + error.message);
                redirectToLogin();
                return false;
            }
        }

        // Load user profile from database
        async function loadUserProfile() {
            try {
                console.log('ğŸ” æŸ¥è©¢ user_profiles è¡¨æ ¼...');
                console.log('   auth_user_id:', currentUser.id);

                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('âŒ Failed to load user profile:', error);
                    console.error('   éŒ¯èª¤ä»£ç¢¼:', error.code);
                    console.error('   éŒ¯èª¤è¨Šæ¯:', error.message);

                    // Check if onboarding not completed
                    if (error.code === 'PGRST116') {
                        console.log('âš ï¸ User profile not found, redirecting to onboarding...');
                        alert('æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œå°‡è½‰åˆ°è¨­å®šé é¢');
                        window.location.href = '/onboarding.html';
                        return false;
                    }

                    alert('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ï¼š' + error.message);
                    return false;
                }

                if (!data) {
                    console.error('âŒ User profile data is null');
                    alert('ä½¿ç”¨è€…è³‡æ–™ç‚ºç©ºï¼Œè«‹é‡æ–°è¨»å†Š');
                    return false;
                }

                userProfile = data;
                console.log('âœ… User profile loaded:', userProfile);
                console.log('   ID:', userProfile.id);
                console.log('   Name:', userProfile.display_name);
                console.log('   Onboarding completed:', userProfile.onboarding_completed);

                // å„²å­˜ elder_id åˆ° localStorageï¼ˆå¦‚æœç”¨æˆ¶æ˜¯é•·è¼©è§’è‰²ï¼‰
                if (userProfile.role === 'elder' && userProfile.elder_id) {
                    localStorage.setItem('currentElderId', userProfile.elder_id);
                    console.log('âœ… Elder ID saved to localStorage:', userProfile.elder_id);
                } else if (userProfile.role === 'elder' && userProfile.id) {
                    // å¦‚æœæ²’æœ‰ elder_idï¼Œä½¿ç”¨ profile id
                    localStorage.setItem('currentElderId', userProfile.id);
                    console.log('âœ… Profile ID saved as Elder ID to localStorage:', userProfile.id);
                }

                // Check if onboarding completed
                if (!userProfile.onboarding_completed) {
                    console.log('âš ï¸ Onboarding not completed, redirecting...');
                    alert('è«‹å…ˆå®Œæˆåˆå§‹è¨­å®š');
                    window.location.href = '/onboarding.html';
                    return false;
                }

                return true;

            } catch (error) {
                console.error('âŒ Error loading profile:', error);
                alert('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                return false;
            }
        }

        // Display user information
        function displayUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const logoutBtn = document.getElementById('logoutBtn');

            if (userProfile) {
                // Show user info
                userName.textContent = userProfile.display_name || currentUser.email;

                // Set avatar
                if (userProfile.avatar_url) {
                    userAvatar.src = userProfile.avatar_url;
                } else {
                    // Use default avatar based on user's initial
                    const initial = (userProfile.display_name || currentUser.email).charAt(0).toUpperCase();
                    userAvatar.src = `https://ui-avatars.com/api/?name=${initial}&background=667eea&color=fff&size=40`;
                }

                userInfoDiv.style.display = 'flex';
                logoutBtn.style.display = 'block';

                // æ ¹æ“šè§’è‰²é¡¯ç¤ºå°æ‡‰çš„å¿«æ·æŒ‰éˆ•
                const elderButtons = document.querySelectorAll('.elder-only');
                const familyButtons = document.querySelectorAll('.family-only');

                if (userProfile.role === 'elder') {
                    elderButtons.forEach(btn => btn.style.display = 'block');
                    familyButtons.forEach(btn => btn.style.display = 'none');
                } else if (userProfile.role === 'family_member') {
                    elderButtons.forEach(btn => btn.style.display = 'none');
                    familyButtons.forEach(btn => btn.style.display = 'block');
                } else {
                    // å…¶ä»–è§’è‰²æˆ–æœªçŸ¥è§’è‰²ï¼Œéƒ½éš±è—
                    elderButtons.forEach(btn => btn.style.display = 'none');
                    familyButtons.forEach(btn => btn.style.display = 'none');
                }
            }
        }

        // Logout function
        async function handleLogout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                try {
                    const { error } = await supabaseClient.auth.signOut();

                    if (error) {
                        console.error('âŒ Logout error:', error);
                        alert('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤');
                        return;
                    }

                    console.log('âœ… Logged out successfully');
                    redirectToLogin();
                } catch (error) {
                    console.error('âŒ Logout failed:', error);
                    alert('ç™»å‡ºå¤±æ•—');
                }
            }
        }

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = '/login.html';
        }

        // Listen for auth state changes
        // æš«æ™‚ç¦ç”¨ä»¥é¿å…è§¸ç™¼é‡è¼‰
        /*
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('ğŸ”„ Auth state changed:', event);

            if (event === 'SIGNED_OUT') {
                redirectToLogin();
            } else if (event === 'SIGNED_IN') {
                window.location.reload();
            }
        });
        */

        // éš±è—åˆå§‹è¼‰å…¥ç•«é¢
        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            const app = document.getElementById('app');

            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }

            if (app) {
                app.classList.add('loaded');
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Initializing ElderCare Companion...');

            try {
                // Check authentication first
                const isAuthenticated = await checkAuth();

                if (!isAuthenticated) {
                    hideInitialLoader();
                    return; // Stop here if not authenticated
                }

                // Setup logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                }

                // Now load the main app
                console.log('âœ… Authentication verified, loading main app...');

                // Wait for app.js to load, then initialize with user data
                if (typeof window.initElderCareApp === 'function') {
                    await window.initElderCareApp(currentUser, userProfile);
                    hideInitialLoader();
                } else {
                    console.log('â³ Waiting for app.js to load...');
                    // Retry after a short delay
                    setTimeout(async () => {
                        if (typeof window.initElderCareApp === 'function') {
                            await window.initElderCareApp(currentUser, userProfile);
                            hideInitialLoader();
                        } else {
                            console.error('âŒ Failed to load app.js');
                            hideInitialLoader();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('âŒ Initialization error:', error);
                hideInitialLoader();
            }
        });
    </script>

    <!-- Global Configuration (è¼‰å…¥é †åºï¼šæœ€å„ªå…ˆ) -->
    <script src="config.js"></script>

    <!-- i18n & Settings -->
    <script src="i18n.js"></script>
    <script src="settings.js"></script>

    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- Main App Logic -->
    <script src="app.js"></script>

    <!-- Firebase é…ç½® -->
    <script src="firebase-config.js"></script>
    <script src="fcm-register.js"></script>

    <!-- Android App åµæ¸¬èˆ‡æ•´åˆ -->
    <script src="app-detection.js"></script>

    <script>
    /**
     * è¨»å†Š FCM Token åˆ°å¾Œç«¯
     */
    async function registerFCMTokenToBackend(token) {
        try {
            // ä½¿ç”¨å·²ç¶“å‰µå»ºçš„ supabaseClientï¼ˆé¿å…å‰µå»ºå¤šå€‹å¯¦ä¾‹ï¼‰
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session || !session.user) {
                console.log('âš ï¸ ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°‡åœ¨ç™»å…¥å¾Œè¨»å†Š FCM Token');
                return false;
            }

            const authUserId = session.user.id;

            // å–å¾—ä½¿ç”¨è€… profile ä»¥ç¢ºå®š userType å’Œå¯¦éš›çš„ userId
            const { data: profile, error: profileError } = await supabaseClient
                .from('user_profiles')
                .select('role, elder_id, family_member_id')
                .eq('auth_user_id', authUserId)
                .single();

            if (profileError || !profile) {
                console.error('âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™:', profileError);
                console.log('ğŸ“ Auth User ID:', authUserId);
                console.log('â„¹ï¸  å¯èƒ½åŸå› ï¼šuser_profiles è¡¨ä¸­æ‰¾ä¸åˆ°æ­¤ä½¿ç”¨è€…ï¼Œè«‹æª¢æŸ¥ onboarding æ˜¯å¦å®Œæˆ');
                return false;
            }

            console.log('âœ… å–å¾—ä½¿ç”¨è€… Profile:', {
                auth_user_id: profile.auth_user_id,
                role: profile.role,
                elder_id: profile.elder_id,
                family_member_id: profile.family_member_id,
                display_name: profile.display_name
            });

            // åˆ¤æ–· userType å’Œå¯¦éš›çš„ userIdï¼ˆæ ¹æ“š roleï¼‰
            let userType;
            let userId;

            if (profile.role === 'family_member' || profile.role === 'family') {
                userType = 'family_member';
                // å„ªå…ˆä½¿ç”¨ family_member_idï¼Œå¦‚æœç‚ºç©ºå‰‡ä½¿ç”¨ profile.id
                userId = profile.family_member_id || profile.id;
            } else if (profile.role === 'elder') {
                userType = 'elder';
                // å„ªå…ˆä½¿ç”¨ elder_idï¼Œå¦‚æœç‚ºç©ºå‰‡ä½¿ç”¨ profile.id
                userId = profile.elder_id || profile.id;
            } else if (profile.role === 'both') {
                // å¦‚æœæ˜¯å…©è€…éƒ½æ˜¯ï¼Œå„ªå…ˆä½¿ç”¨ elder
                userType = 'elder';
                userId = profile.elder_id || profile.id;
            } else {
                // æœªçŸ¥è§’è‰²ï¼Œä½¿ç”¨ profile.id ä¸¦è¨­å®šç‚º elder
                console.warn('âš ï¸ æœªçŸ¥è§’è‰²ï¼Œä½¿ç”¨é è¨­å€¼');
                userType = 'elder';
                userId = profile.id;
            }

            if (!userId) {
                console.error('âŒ ç„¡æ³•å–å¾—ä½¿ç”¨è€… ID');
                console.error('ğŸ“Š Profile è³‡è¨Š:', profile);
                console.error('â„¹ï¸  å¯èƒ½åŸå› ï¼šprofile.id ä¹Ÿç‚º null');
                console.error('ğŸ’¡ å»ºè­°ï¼šè«‹é‡æ–°å®Œæˆ onboarding æµç¨‹');
                return false;
            }

            console.log('âœ… ä½¿ç”¨è€… ID å·²ç¢ºå®š:', userId, '(é¡å‹:', userType + ')');

            // å–å¾—è£ç½®è³‡è¨Š
            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                timestamp: new Date().toISOString()
            };

            console.log('ğŸ“¤ æ­£åœ¨è¨»å†Š FCM Token åˆ°å¾Œç«¯...');
            console.log('   userId:', userId);
            console.log('   userType:', userType);
            console.log('   token:', token.substring(0, 20) + '...');

            // ç™¼é€åˆ°å¾Œç«¯
            const response = await fetch(`${API_BASE_URL}/api/fcm/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId,
                    userType: userType,
                    fcmToken: token,
                    deviceInfo: deviceInfo
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('âŒ FCM Token è¨»å†Šå¤±æ•—:', errorData);
                return false;
            }

            const result = await response.json();
            console.log('âœ… FCM Token è¨»å†ŠæˆåŠŸ:', result);

            // å„²å­˜è¨»å†Šæ™‚é–“
            localStorage.setItem('fcm_token_registered_at', new Date().toISOString());

            return true;

        } catch (error) {
            console.error('âŒ è¨»å†Š FCM Token æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    }

    // åˆå§‹åŒ– FCM
    (async function() {
        const initialized = await window.FCM.init();

        if (initialized) {
            // è«‹æ±‚é€šçŸ¥æ¬Šé™
            const token = await window.FCM.requestPermission();

            if (token) {
                // å°‡ Token å„²å­˜åˆ° localStorage
                localStorage.setItem('fcm_token', token);
                console.log('âœ… FCM Token å·²å–å¾—ä¸¦å„²å­˜');

                // ç™¼é€åˆ°å¾Œç«¯å„²å­˜
                const registered = await registerFCMTokenToBackend(token);

                if (registered) {
                    console.log('âœ… FCM Token å·²æˆåŠŸè¨»å†Šåˆ°å¾Œç«¯');
                } else {
                    console.log('âš ï¸ FCM Token æœªè¨»å†Šåˆ°å¾Œç«¯ï¼ˆå¯èƒ½ä½¿ç”¨è€…æœªç™»å…¥ï¼‰');

                    // ç›£è½ç™»å…¥äº‹ä»¶ï¼Œåœ¨ç™»å…¥å¾Œé‡æ–°è¨»å†Š
                    window.addEventListener('user-logged-in', async () => {
                        console.log('ğŸ”„ ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œé‡æ–°è¨»å†Š FCM Token...');
                        const reregistered = await registerFCMTokenToBackend(token);
                        if (reregistered) {
                            console.log('âœ… FCM Token é‡æ–°è¨»å†ŠæˆåŠŸ');
                        }
                    });
                }
            }

            // ç›£è½å‰æ™¯è¨Šæ¯
            window.FCM.listenToMessages((payload) => {
                console.log('ğŸ“¬ æ”¶åˆ°é€šçŸ¥:', payload);

                // é¡¯ç¤ºé€šçŸ¥ï¼ˆå¦‚æœæœ‰é€šçŸ¥æ¬Šé™ï¼‰
                if (payload.notification) {
                    const notification = payload.notification;

                    // å¦‚æœç€è¦½å™¨æ”¯æ´é€šçŸ¥ APIï¼Œå¯ä»¥é¡¯ç¤ºæ¡Œé¢é€šçŸ¥
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification(notification.title, {
                            body: notification.body,
                            icon: '/icons/icon-192x192.png',
                            badge: '/icons/icon-72x72.png'
                        });
                    }
                }
            });
        }
    })();

    // æš´éœ²å…¨åŸŸå‡½æ•¸ä¾›å…¶ä»–é é¢ä½¿ç”¨
    window.registerFCMTokenToBackend = registerFCMTokenToBackend;
    </script>


</body>
</html>
