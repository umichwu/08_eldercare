<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¾¤çµ„èŠå¤©åŠŸèƒ½">
    <meta name="theme-color" content="#4CAF50">
    <title>ç¾¤çµ„èŠå¤© - ElderCare</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Styles -->
    <link rel="stylesheet" href="social.css">
    <style>
        /* ç¾¤çµ„èŠå¤©ç‰¹å®šæ¨£å¼ */
        .group-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .group-member-count {
            font-size: 0.85rem;
            color: #666;
            margin-left: 8px;
        }

        .group-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .message-sender-name {
            font-size: 0.85rem;
            color: #4CAF50;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .group-info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
        }

        .member-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            gap: 12px;
        }

        .member-role-badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .member-role-badge.admin {
            background: #ff9800;
            color: white;
        }

        .member-role-badge.moderator {
            background: #2196F3;
            color: white;
        }

        .member-role-badge.member {
            background: #e0e0e0;
            color: #666;
        }
    </style>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <header class="social-header">
        <button class="header-back-btn" onclick="window.location.href='index.html'">
            <span class="back-arrow">â†</span>
            <span>è¿”å›</span>
        </button>
        <h1 class="header-title">
            <span class="header-icon">ğŸ‘¥</span>
            ç¾¤çµ„èŠå¤©
        </h1>
        <div class="header-actions">
            <button class="header-btn" onclick="showNotifications()" title="é€šçŸ¥">
                <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
                ğŸ””
            </button>
            <button class="header-btn" onclick="showInviteFriendModal()" title="é‚€è«‹å¥½å‹">
                âœ‰ï¸
            </button>
            <button class="header-btn" onclick="showCreateGroupModal()" title="å»ºç«‹ç¾¤çµ„">
                â•
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ - å·¦å³åˆ†æ¬„æ¶æ§‹ -->
    <div class="social-main-container">
        <!-- å·¦å´ï¼šç¾¤çµ„åˆ—è¡¨ -->
        <aside class="friends-sidebar">
            <!-- æœå°‹æ¡† -->
            <div class="sidebar-search">
                <input type="text"
                       id="groupSearchInput"
                       class="search-input"
                       placeholder="ğŸ” æœå°‹ç¾¤çµ„..."
                       oninput="filterGroups(event)">
            </div>

            <!-- ç¾¤çµ„åˆ—è¡¨ -->
            <div class="friends-list" id="groupsList">
                <!-- è¼‰å…¥ä¸­ -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ç¾¤çµ„åˆ—è¡¨ä¸­...</p>
                </div>
            </div>

            <!-- ç„¡ç¾¤çµ„æç¤º -->
            <div id="noGroupsPlaceholder" class="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ‘¥</div>
                <h3>é‚„æ²’æœ‰ç¾¤çµ„</h3>
                <p>å»ºç«‹æˆ–åŠ å…¥ç¾¤çµ„ï¼Œé–‹å§‹ç¾¤èŠå§ï¼</p>
                <button class="btn-primary" onclick="showCreateGroupModal()">
                    â• å»ºç«‹ç¾¤çµ„
                </button>
            </div>
        </aside>

        <!-- å³å´ï¼šå…§å®¹å€åŸŸ -->
        <main class="content-area">
            <!-- æœªé¸æ“‡ç¾¤çµ„çš„æ­¡è¿ç•«é¢ -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">ğŸ‘¥</div>
                    <h2>æ­¡è¿ä¾†åˆ°ç¾¤çµ„èŠå¤©</h2>
                    <p class="welcome-text">é¸æ“‡å·¦å´çš„ç¾¤çµ„é–‹å§‹èŠå¤©ï¼Œæˆ–å»ºç«‹æ–°ç¾¤çµ„</p>
                    <div class="welcome-quick-actions">
                        <button class="quick-action-btn" onclick="showCreateGroupModal()">
                            <span class="action-icon">â•</span>
                            <span>å»ºç«‹ç¾¤çµ„</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¾¤çµ„èŠå¤©å€ -->
            <div id="groupChatArea" class="chat-area" style="display: none;">
                <!-- èŠå¤©æ¨™é¡Œæ¬„ -->
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="group-avatar" id="currentGroupAvatar">ğŸ‘¥</div>
                        <div class="chat-header-info">
                            <h2 class="chat-header-name" id="currentGroupName">ç¾¤çµ„åç¨±</h2>
                            <p class="chat-header-status" id="currentGroupInfo">
                                <span id="currentGroupMemberCount">0</span> ä½æˆå“¡
                            </p>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="header-btn" onclick="showGroupMembers()" title="æˆå“¡åˆ—è¡¨">
                            ğŸ‘¥
                        </button>
                        <button class="header-btn" onclick="showGroupSettings()" title="ç¾¤çµ„è¨­å®š">
                            âš™ï¸
                        </button>
                    </div>
                </div>

                <!-- è¨Šæ¯åˆ—è¡¨ -->
                <div class="messages-container" id="messagesContainer">
                    <!-- è¨Šæ¯æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>

                <!-- è¼¸å…¥å€ -->
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <button class="chat-input-btn" onclick="selectImage()" title="ä¸Šå‚³åœ–ç‰‡">
                            ğŸ“·
                        </button>
                        <textarea
                            id="messageInput"
                            class="chat-input"
                            placeholder="è¼¸å…¥è¨Šæ¯..."
                            rows="1"
                            onkeypress="handleMessageKeyPress(event)"></textarea>
                        <button class="chat-send-btn" onclick="sendGroupMessage()">
                            ç™¼é€
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å»ºç«‹ç¾¤çµ„å°è©±æ¡† -->
    <div id="createGroupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å»ºç«‹æ–°ç¾¤çµ„</h2>
                <button class="modal-close-btn" onclick="hideCreateGroupModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm" onsubmit="createGroup(event)">
                    <div class="form-group">
                        <label for="groupName">ç¾¤çµ„åç¨± *</label>
                        <input type="text"
                               id="groupName"
                               class="form-input"
                               placeholder="è«‹è¼¸å…¥ç¾¤çµ„åç¨±"
                               required
                               maxlength="100">
                    </div>

                    <div class="form-group">
                        <label for="groupDescription">ç¾¤çµ„æè¿°</label>
                        <textarea
                            id="groupDescription"
                            class="form-input"
                            placeholder="è«‹è¼¸å…¥ç¾¤çµ„æè¿°ï¼ˆå¯é¸ï¼‰"
                            rows="3"
                            maxlength="500"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="groupAvatarUrl">ç¾¤çµ„é ­åƒç¶²å€</label>
                        <input type="url"
                               id="groupAvatarUrl"
                               class="form-input"
                               placeholder="https://example.com/avatar.jpgï¼ˆå¯é¸ï¼‰">
                    </div>

                    <div class="form-group">
                        <label for="maxMembers">äººæ•¸ä¸Šé™</label>
                        <input type="number"
                               id="maxMembers"
                               class="form-input"
                               value="50"
                               min="2"
                               max="500">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isPrivate">
                            <span>ç§å¯†ç¾¤çµ„ï¼ˆéœ€è¦é‚€è«‹æ‰èƒ½åŠ å…¥ï¼‰</span>
                        </label>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="hideCreateGroupModal()">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn-primary">
                            å»ºç«‹ç¾¤çµ„
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç¾¤çµ„æˆå“¡åˆ—è¡¨å°è©±æ¡† -->
    <div id="groupMembersModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¾¤çµ„æˆå“¡</h2>
                <button class="modal-close-btn" onclick="hideGroupMembersModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- æˆå“¡åˆ—è¡¨ -->
                <div id="membersList" class="members-list">
                    <!-- æˆå“¡æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>

                <!-- æ–°å¢æˆå“¡æŒ‰éˆ• -->
                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="showAddMemberModal()">
                        â• æ–°å¢æˆå“¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾¤çµ„è¨­å®šå°è©±æ¡† -->
    <div id="groupSettingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¾¤çµ„è¨­å®š</h2>
                <button class="modal-close-btn" onclick="hideGroupSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="groupSettingsForm" onsubmit="updateGroupSettings(event)">
                    <div class="form-group">
                        <label for="editGroupName">ç¾¤çµ„åç¨±</label>
                        <input type="text"
                               id="editGroupName"
                               class="form-input"
                               placeholder="è«‹è¼¸å…¥ç¾¤çµ„åç¨±"
                               required
                               maxlength="100">
                    </div>

                    <div class="form-group">
                        <label for="editGroupDescription">ç¾¤çµ„æè¿°</label>
                        <textarea
                            id="editGroupDescription"
                            class="form-input"
                            placeholder="è«‹è¼¸å…¥ç¾¤çµ„æè¿°"
                            rows="3"
                            maxlength="500"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editGroupAvatarUrl">ç¾¤çµ„é ­åƒç¶²å€</label>
                        <input type="url"
                               id="editGroupAvatarUrl"
                               class="form-input"
                               placeholder="https://example.com/avatar.jpg">
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="hideGroupSettingsModal()">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn-primary">
                            å„²å­˜è®Šæ›´
                        </button>
                        <button type="button" class="btn-danger" onclick="leaveGroup()" style="margin-left: auto;">
                            é›¢é–‹ç¾¤çµ„
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æˆå“¡å°è©±æ¡† -->
    <div id="addMemberModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å¢æˆå“¡</h2>
                <button class="modal-close-btn" onclick="hideAddMemberModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="searchUserInput">æœå°‹ä½¿ç”¨è€…</label>
                    <input type="text"
                           id="searchUserInput"
                           class="form-input"
                           placeholder="è¼¸å…¥ä½¿ç”¨è€…åç¨±æˆ– Email"
                           oninput="searchUsers(event)">
                </div>

                <!-- æœå°‹çµæœ -->
                <div id="userSearchResults" class="search-results">
                    <!-- æœå°‹çµæœæœƒå‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

    <!-- é‚€è«‹å¥½å‹å°è©±æ¡† -->
    <div id="inviteFriendModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœ‰ï¸ é‚€è«‹å¥½å‹åŠ å…¥ ElderCare</h2>
                <button class="modal-close-btn" onclick="hideInviteFriendModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                    é€é Email é‚€è«‹æ‚¨çš„æœ‹å‹åŠ å…¥ ElderCareï¼Œä¸€èµ·äº«å—é•·è¼©ç…§è­·çš„ä¾¿åˆ©åŠŸèƒ½ï¼
                </p>

                <form id="inviteFriendForm" onsubmit="sendEmailInvitation(event)">
                    <div class="form-group">
                        <label for="friendEmail">å¥½å‹çš„ Email *</label>
                        <input type="email"
                               id="friendEmail"
                               class="form-input"
                               placeholder="è«‹è¼¸å…¥å¥½å‹çš„ Email åœ°å€"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="inviteMessage">å€‹äººè¨Šæ¯ï¼ˆå¯é¸ï¼‰</label>
                        <textarea
                            id="inviteMessage"
                            class="form-input"
                            placeholder="å¯«ä¸€æ®µè©±é‚€è«‹æ‚¨çš„æœ‹å‹..."
                            rows="4"
                            maxlength="500"></textarea>
                        <small style="color: #999; font-size: 0.85rem;">æœ€å¤š 500 å­—</small>
                    </div>

                    <div style="background: #f5f7fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">
                            <strong>ğŸ“§ æ‚¨çš„æœ‹å‹å°‡æœƒæ”¶åˆ°ï¼š</strong><br>
                            ä¸€å°åŒ…å« ElderCare ä»‹ç´¹å’Œè¨»å†Šé€£çµçš„é‚€è«‹éƒµä»¶
                        </p>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="hideInviteFriendModal()">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn-primary" id="sendInviteBtn">
                            ç™¼é€é‚€è«‹
                        </button>
                    </div>
                </form>

                <!-- æˆåŠŸè¨Šæ¯ -->
                <div id="inviteSuccessMessage" style="display: none; margin-top: 20px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
                    <strong>âœ… é‚€è«‹å·²æˆåŠŸç™¼é€ï¼</strong><br>
                    æ‚¨çš„æœ‹å‹å°‡æœƒæ”¶åˆ°é‚€è«‹éƒµä»¶ã€‚
                </div>

                <!-- éŒ¯èª¤è¨Šæ¯ -->
                <div id="inviteErrorMessage" style="display: none; margin-top: 20px; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                    <strong>âŒ ç™¼é€å¤±æ•—</strong><br>
                    <span id="inviteErrorText">è«‹ç¨å¾Œå†è©¦ã€‚</span>
                </div>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="group-chat.js"></script>
</body>
</html>
