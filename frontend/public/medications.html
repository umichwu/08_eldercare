<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用藥管理 - ElderCare</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles-modern.css">
    <link rel="stylesheet" href="mobile-modern.css">
    <link rel="stylesheet" href="medications.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="top-nav">
        <button class="nav-back" onclick="window.location.href='index.html'">
            ← 返回
        </button>
        <h1 class="nav-title">💊 用藥管理</h1>
        <button class="nav-settings" onclick="showSettings()">
            ⚙️
        </button>
    </nav>

    <!-- 主要內容 -->
    <div class="medication-container">
        <!-- 標籤切換 -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="medications" onclick="switchTab('medications')">
                📋 藥物列表
            </button>
            <button class="tab-btn" data-tab="today" onclick="switchTab('today')">
                📅 今日用藥
            </button>
            <button class="tab-btn" data-tab="stats" onclick="switchTab('stats')">
                📊 統計
            </button>
        </div>

        <!-- 藥物列表標籤 -->
        <div id="medications-tab" class="tab-content active">
            <!-- 搜尋和新增 -->
            <div class="action-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 搜尋藥物名稱..."
                           oninput="searchMedications(this.value)">
                </div>
                <button class="btn-primary" onclick="showAddMedicationForm()">
                    ➕ 新增藥物
                </button>
            </div>

            <!-- 藥物卡片列表 -->
            <div id="medicationsList" class="medications-list">
                <!-- 載入中 -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                </div>
            </div>

            <!-- 空狀態 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">💊</div>
                <h3>還沒有藥物記錄</h3>
                <p>點擊上方「新增藥物」按鈕開始管理您的用藥</p>
                <button class="btn-primary" onclick="showAddMedicationForm()">
                    ➕ 新增第一個藥物
                </button>
            </div>
        </div>

        <!-- 今日用藥標籤 -->
        <div id="today-tab" class="tab-content">
            <div class="today-header">
                <h2>📅 今日用藥計劃</h2>
                <p class="today-date" id="todayDate"></p>
            </div>

            <!-- 今日統計 -->
            <div class="today-stats">
                <div class="stat-card">
                    <div class="stat-value" id="todayTotal">0</div>
                    <div class="stat-label">總計</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="todayTaken">0</div>
                    <div class="stat-label">已服用</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="todayPending">0</div>
                    <div class="stat-label">待服用</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="todayMissed">0</div>
                    <div class="stat-label">已錯過</div>
                </div>
            </div>

            <!-- 今日時間軸 -->
            <div id="todayTimeline" class="today-timeline">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入今日用藥...</p>
                </div>
            </div>
        </div>

        <!-- 統計標籤 -->
        <div id="stats-tab" class="tab-content">
            <div class="stats-header">
                <h2>📊 用藥統計</h2>
                <select id="statsPeriod" onchange="loadStatistics(this.value)">
                    <option value="7">過去 7 天</option>
                    <option value="14">過去 14 天</option>
                    <option value="30">過去 30 天</option>
                </select>
            </div>

            <!-- 統計卡片 -->
            <div id="statisticsCards" class="statistics-cards">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入統計資料...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯藥物 Modal (快速設定模式) -->
    <div id="medicationModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">➕ 快速新增用藥提醒</h2>
                <button class="modal-close" onclick="closeMedicationModal()">&times;</button>
            </div>
            <form id="medicationForm" onsubmit="saveMedication(event)">
                <!-- 基本資訊 (必填) -->
                <div class="form-section">
                    <h3>📋 基本資訊</h3>
                    <div class="form-group">
                        <label for="medicationName">藥物名稱 *</label>
                        <input type="text" id="medicationName" required placeholder="例如：降血壓藥、阿斯匹靈">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dosage">每次劑量 *</label>
                            <input type="text" id="dosage" required placeholder="例如：1 顆、5ml">
                        </div>
                        <div class="form-group">
                            <label for="mealTiming">用藥時機 *</label>
                            <select id="mealTiming" required>
                                <option value="">請選擇</option>
                                <option value="before_meal">飯前（30分鐘前）</option>
                                <option value="with_meal">飯中（隨餐）</option>
                                <option value="after_meal">飯後（30分鐘後）</option>
                                <option value="anytime">不限時間</option>
                                <option value="bedtime">睡前</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 提醒時間 (必填) -->
                <div class="form-section">
                    <h3>⏰ 提醒時間 *</h3>
                    <div id="reminderTimesContainer">
                        <div class="time-input-group">
                            <input type="time" class="reminder-time" required>
                            <button type="button" class="btn-icon danger" onclick="removeReminderTime(this)" style="display: none;">
                                ❌
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary btn-small" onclick="addReminderTimeInForm()">
                        ➕ 新增時間
                    </button>
                    <p class="help-text">💡 例如：早上 8:00、中午 12:00、晚上 18:00</p>
                </div>

                <!-- 進階設定 (選填，可展開) -->
                <div class="form-section collapsible">
                    <h3 onclick="toggleSection(this)">
                        🔽 進階設定（選填）
                    </h3>
                    <div class="collapsible-content" style="display: none;">
                        <div class="form-group">
                            <label for="medicationType">藥物類型</label>
                            <select id="medicationType">
                                <option value="">請選擇</option>
                                <option value="tablet">藥片/錠劑</option>
                                <option value="capsule">膠囊</option>
                                <option value="liquid">藥水/糖漿</option>
                                <option value="injection">注射劑</option>
                                <option value="topical">外用藥</option>
                                <option value="antibiotic">抗生素</option>
                            </select>
                        </div>

                        <div class="form-group" id="antibioticDaysGroup" style="display: none;">
                            <label for="antibioticDays">抗生素療程天數</label>
                            <input type="number" id="antibioticDays" min="1" max="30" placeholder="例如：7">
                            <small>⚠️ 抗生素需按時服用完整療程</small>
                        </div>

                        <div class="form-group">
                            <label for="purpose">用藥目的</label>
                            <input type="text" id="purpose" placeholder="例如：降血壓、控制血糖">
                        </div>

                        <div class="form-group">
                            <label for="instructions">服用說明</label>
                            <textarea id="instructions" rows="2" placeholder="例如：配溫開水服用、需要整顆吞服"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="sideEffects">可能副作用</label>
                            <textarea id="sideEffects" rows="2" placeholder="例如：可能會頭暈、嗜睡"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prescribingDoctor">處方醫師</label>
                                <input type="text" id="prescribingDoctor" placeholder="例如：王大明醫師">
                            </div>
                            <div class="form-group">
                                <label for="stockQuantity">藥物庫存</label>
                                <input type="number" id="stockQuantity" value="30" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="medicationId">

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeMedicationModal()">
                        取消
                    </button>
                    <button type="submit" class="btn-primary">
                        💾 儲存並啟用提醒
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 提醒設定 Modal -->
    <div id="reminderModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>⏰ 提醒設定</h2>
                <button class="modal-close" onclick="closeReminderModal()">&times;</button>
            </div>
            <div id="reminderContent">
                <!-- 動態載入 -->
            </div>
        </div>
    </div>

    <!-- Email 設定 Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📧 Email 通知設定</h2>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <form id="emailForm" onsubmit="saveEmailSettings(event)">
                <div class="form-group">
                    <label for="userEmail">Email 地址</label>
                    <input type="email" id="userEmail" placeholder="your.email@example.com">
                    <small>設定後將會收到用藥提醒郵件</small>
                </div>

                <div class="form-group">
                    <button type="button" class="btn-secondary" onclick="testEmail()">
                        📧 發送測試郵件
                    </button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEmailModal()">
                        取消
                    </button>
                    <button type="submit" class="btn-primary">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="medications.js"></script>
</body>
</html>
