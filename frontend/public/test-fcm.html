<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM æ¨é€é€šçŸ¥æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            border-left: 5px solid;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 3px 0;
        }
        .log-success { color: #00ff00; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ffaa00; }
        .log-info { color: #00aaff; }
        .token-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        .elder-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” FCM æ¨é€é€šçŸ¥å®Œæ•´æ¸¬è©¦å·¥å…·</h1>

        <!-- ç³»çµ±ç‹€æ…‹æª¢æŸ¥ -->
        <div class="section">
            <h3>ğŸ“‹ ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
            <div id="browserSupport"></div>
            <div id="notificationPermission"></div>
            <div id="serviceWorkerStatus"></div>
            <div id="fcmInitStatus"></div>
        </div>

        <!-- é•·è¼©è³‡è¨Š -->
        <div class="section">
            <h3>ğŸ‘´ ç•¶å‰é•·è¼©è³‡è¨Š</h3>
            <div id="elderInfo"></div>
            <div style="margin-top: 15px;">
                <label for="elderIdInput" style="display: block; margin-bottom: 5px; font-weight: bold;">æ‰‹å‹•è¼¸å…¥é•·è¼© IDï¼š</label>
                <input type="text" id="elderIdInput" placeholder="ä¾‹å¦‚: fe50db48-6d33-4777-803b-8b335625c9c2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                <button class="btn" onclick="setElderId()" style="margin-top: 10px;">è¨­å®šé•·è¼© ID</button>
            </div>
        </div>

        <!-- FCM Token è³‡è¨Š -->
        <div class="section">
            <h3>ğŸ”‘ FCM Token ç‹€æ…‹</h3>
            <div id="tokenStatus"></div>
            <div id="tokenDisplay"></div>
            <button class="btn" id="btnGetToken">1ï¸âƒ£ è«‹æ±‚é€šçŸ¥æ¬Šé™ & å–å¾— FCM Token</button>
            <button class="btn" id="btnRegisterToken" disabled>2ï¸âƒ£ è¨»å†Š Token åˆ°è³‡æ–™åº«</button>
        </div>

        <!-- æ¸¬è©¦æ¨é€ -->
        <div class="section">
            <h3>ğŸš€ æ¸¬è©¦æ¨é€é€šçŸ¥</h3>
            <button class="btn" id="btnTestFCM" disabled>3ï¸âƒ£ ç™¼é€æ¸¬è©¦ FCM æ¨é€</button>
            <button class="btn" id="btnTestMedicationReminder" disabled>4ï¸âƒ£ æ¨¡æ“¬ç”¨è—¥æé†’æ¨é€</button>
        </div>

        <!-- è¨ºæ–·æ—¥èªŒ -->
        <div class="section">
            <h3>ğŸ“ è¨ºæ–·æ—¥èªŒ</h3>
            <button class="btn" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- è¼‰å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAD1k65QMjmbar0N78ako9o9zI8TcbQAgc",
            authDomain: "eldercare-companion-6d4ef.firebaseapp.com",
            projectId: "eldercare-companion-6d4ef",
            storageBucket: "eldercare-companion-6d4ef.firebasestorage.app",
            messagingSenderId: "642412075428",
            appId: "1:642412075428:web:719d07acbc1fa76ba0c931",
            measurementId: "G-2KYT49V9P0"
        };

        // VAPID Key (å¾ Firebase Console å–å¾—)
        // Firebase Console > Project Settings > Cloud Messaging > Web Push certificates
        const VAPID_KEY = 'BNVdBNLwYovRVSWmdrzEubJVdyLxeUxodYkMg1mTboke-34vjS4Ud2-dH3XgTqY8qOw0rihx6WEHVc4OQA404wo';

        // é»˜èªé•·è¼© IDï¼ˆæ¸¬è©¦ç”¨ï¼‰
        const DEFAULT_ELDER_ID = 'fe50db48-6d33-4777-803b-8b335625c9c2';

        let messaging = null;
        let currentToken = null;
        let currentElderId = DEFAULT_ELDER_ID;

        // æ—¥èªŒå‡½æ•¸
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, message, statusType) {
            const el = document.getElementById(elementId);
            el.className = `status-box status-${statusType}`;
            el.innerHTML = message;
        }

        // 1. æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
        function checkBrowserSupport() {
            if (!('serviceWorker' in navigator)) {
                updateStatus('browserSupport', 'âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Service Worker', 'error');
                log('ç€è¦½å™¨ä¸æ”¯æ´ Service Worker', 'error');
                return false;
            }
            if (!('PushManager' in window)) {
                updateStatus('browserSupport', 'âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´æ¨é€é€šçŸ¥', 'error');
                log('ç€è¦½å™¨ä¸æ”¯æ´æ¨é€é€šçŸ¥', 'error');
                return false;
            }
            if (!('Notification' in window)) {
                updateStatus('browserSupport', 'âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Notification API', 'error');
                log('ç€è¦½å™¨ä¸æ”¯æ´ Notification API', 'error');
                return false;
            }

            updateStatus('browserSupport', 'âœ… ç€è¦½å™¨æ”¯æ´æ‰€æœ‰å¿…è¦åŠŸèƒ½', 'success');
            log('ç€è¦½å™¨æª¢æŸ¥é€šé', 'success');
            return true;
        }

        // 2. æª¢æŸ¥é€šçŸ¥æ¬Šé™
        function checkNotificationPermission() {
            const permission = Notification.permission;
            log(`ç•¶å‰é€šçŸ¥æ¬Šé™: ${permission}`, 'info');

            if (permission === 'granted') {
                updateStatus('notificationPermission', 'âœ… é€šçŸ¥æ¬Šé™å·²æˆäºˆ', 'success');
                return true;
            } else if (permission === 'denied') {
                updateStatus('notificationPermission', 'âŒ é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•ï¼ˆè«‹æ‰‹å‹•é–‹å•Ÿï¼‰', 'error');
                return false;
            } else {
                updateStatus('notificationPermission', 'âš ï¸ é€šçŸ¥æ¬Šé™å°šæœªè©¢å•', 'warning');
                return false;
            }
        }

        // 3. åˆå§‹åŒ– Firebase Messaging
        async function initFirebase() {
            try {
                log('æ­£åœ¨åˆå§‹åŒ– Firebase...', 'info');
                const app = initializeApp(firebaseConfig);
                messaging = getMessaging(app);

                updateStatus('fcmInitStatus', 'âœ… Firebase Messaging åˆå§‹åŒ–æˆåŠŸ', 'success');
                log('Firebase Messaging åˆå§‹åŒ–æˆåŠŸ', 'success');

                // ç›£è½å‰æ™¯è¨Šæ¯
                onMessage(messaging, (payload) => {
                    log('ğŸ“© æ”¶åˆ°å‰æ™¯è¨Šæ¯: ' + JSON.stringify(payload), 'success');
                    alert('æ”¶åˆ°æ¨é€é€šçŸ¥ï¼\n' + payload.notification?.title + '\n' + payload.notification?.body);
                });

                return true;
            } catch (error) {
                updateStatus('fcmInitStatus', 'âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                log('Firebase åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                return false;
            }
        }

        // 4. æª¢æŸ¥ Service Worker
        async function checkServiceWorker() {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`æ‰¾åˆ° ${registrations.length} å€‹ Service Worker`, 'info');

                if (registrations.length > 0) {
                    updateStatus('serviceWorkerStatus', `âœ… Service Worker å·²è¨»å†Š (${registrations.length} å€‹)`, 'success');
                    registrations.forEach((reg, i) => {
                        log(`  SW ${i+1}: ${reg.active?.scriptURL || 'pending'}`, 'info');
                    });
                } else {
                    updateStatus('serviceWorkerStatus', 'âš ï¸ å°šæœªè¨»å†Š Service Worker', 'warning');
                }
            } catch (error) {
                updateStatus('serviceWorkerStatus', 'âŒ æª¢æŸ¥ Service Worker å¤±æ•—', 'error');
                log('æª¢æŸ¥ Service Worker å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ‰‹å‹•è¨­å®šé•·è¼© ID
        window.setElderId = async function() {
            const input = document.getElementById('elderIdInput');
            const elderId = input.value.trim();

            if (!elderId) {
                alert('è«‹è¼¸å…¥é•·è¼© ID');
                return;
            }

            log(`è¨­å®šé•·è¼© ID: ${elderId}`, 'info');
            localStorage.setItem('currentElderId', elderId);
            currentElderId = elderId;

            // é‡æ–°ç²å–é•·è¼©è³‡è¨Š
            const elder = await getElderInfo();

            // æä¾›ç”¨æˆ¶åé¥‹
            if (elder) {
                alert(`âœ… é•·è¼© ID è¨­å®šæˆåŠŸï¼\n\nå§“å: ${elder.name}\nID: ${elder.id}\nFCM Token: ${elder.fcm_token ? 'å·²è¨»å†Š' : 'æœªè¨»å†Š'}`);
                log(`âœ… é•·è¼© ID è¨­å®šæˆåŠŸ: ${elder.name}`, 'success');
            } else {
                alert('âŒ ç„¡æ³•å–å¾—é•·è¼©è³‡è¨Šï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢ºæˆ–å¾Œç«¯æ˜¯å¦é‹è¡Œ');
                log('âŒ è¨­å®šé•·è¼© ID å¤±æ•—', 'error');
            }
        };

        // 5. å–å¾—é•·è¼©è³‡è¨Š
        async function getElderInfo() {
            try {
                log('æ­£åœ¨ç²å–é•·è¼©è³‡è¨Š...', 'info');

                // å„ªå…ˆä½¿ç”¨é»˜èªé•·è¼© ID
                let elderId = currentElderId || DEFAULT_ELDER_ID;

                // å˜—è©¦å¾è¼¸å…¥æ¡†å–å¾—ï¼ˆå¦‚æœç”¨æˆ¶æ‰‹å‹•è¼¸å…¥äº†ï¼‰
                const input = document.getElementById('elderIdInput');
                if (input && input.value.trim()) {
                    elderId = input.value.trim();
                }

                currentElderId = elderId;
                localStorage.setItem('currentElderId', elderId);

                // å¾å¾Œç«¯ API å–å¾—é•·è¼©è³‡æ–™
                const response = await fetch(`http://localhost:3000/api/elders/${elderId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const elder = await response.json();
                log(`æˆåŠŸå–å¾—é•·è¼©è³‡æ–™: ${elder.name}`, 'success');

                updateStatus('elderInfo', `
                    <div class="elder-info">
                        <strong>å§“å:</strong> ${elder.name}<br>
                        <strong>ID:</strong> ${elder.id}<br>
                        <strong>FCM Token:</strong> ${elder.fcm_token ? 'âœ… å·²è¨»å†Š' : 'âŒ æœªè¨»å†Š'}
                    </div>
                `, 'info');

                return elder;
            } catch (error) {
                updateStatus('elderInfo', 'âŒ ç„¡æ³•å–å¾—é•·è¼©è³‡è¨Š: ' + error.message, 'error');
                log('å–å¾—é•·è¼©è³‡è¨Šå¤±æ•—: ' + error.message, 'error');
                return null;
            }
        }

        // 6. å–å¾— FCM Token
        async function getFCMToken() {
            try {
                log('æ­£åœ¨è«‹æ±‚é€šçŸ¥æ¬Šé™...', 'info');

                // è«‹æ±‚é€šçŸ¥æ¬Šé™
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    updateStatus('tokenStatus', 'âŒ ä½¿ç”¨è€…æ‹’çµ•é€šçŸ¥æ¬Šé™', 'error');
                    log('ä½¿ç”¨è€…æ‹’çµ•é€šçŸ¥æ¬Šé™', 'error');
                    return null;
                }

                log('é€šçŸ¥æ¬Šé™å·²æˆäºˆï¼Œæ­£åœ¨è¨»å†Š Service Worker...', 'success');

                // è¨»å†Š Service Worker
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                await navigator.serviceWorker.ready;
                log('Service Worker è¨»å†ŠæˆåŠŸ', 'success');

                updateStatus('serviceWorkerStatus', 'âœ… Service Worker å·²è¨»å†Šä¸¦å°±ç·’', 'success');

                log('æ­£åœ¨å–å¾— FCM Token...', 'info');

                // å–å¾— FCM Token
                const token = await getToken(messaging, {
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: registration
                });

                if (!token) {
                    throw new Error('ç„¡æ³•å–å¾— FCM Token');
                }

                currentToken = token;
                log('âœ… FCM Token å–å¾—æˆåŠŸ', 'success');
                log('Token: ' + token.substring(0, 50) + '...', 'info');

                updateStatus('tokenStatus', 'âœ… FCM Token å·²å–å¾—', 'success');
                document.getElementById('tokenDisplay').innerHTML = `
                    <div class="token-display">${token}</div>
                `;

                // å•Ÿç”¨è¨»å†ŠæŒ‰éˆ•
                document.getElementById('btnRegisterToken').disabled = false;

                return token;
            } catch (error) {
                updateStatus('tokenStatus', 'âŒ å–å¾— FCM Token å¤±æ•—: ' + error.message, 'error');
                log('å–å¾— FCM Token å¤±æ•—: ' + error.message, 'error');
                return null;
            }
        }

        // 7. è¨»å†Š Token åˆ°è³‡æ–™åº«
        async function registerTokenToDatabase() {
            try {
                if (!currentToken || !currentElderId) {
                    alert('è«‹å…ˆå–å¾— FCM Token å’Œé•·è¼©è³‡è¨Š');
                    return;
                }

                log('æ­£åœ¨è¨»å†Š Token åˆ°è³‡æ–™åº«...', 'info');

                const response = await fetch('http://localhost:3000/api/fcm/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentElderId,
                        userType: 'elder',
                        fcmToken: currentToken,
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                log('âœ… Token è¨»å†ŠæˆåŠŸï¼', 'success');
                updateStatus('tokenStatus', 'âœ… FCM Token å·²è¨»å†Šåˆ°è³‡æ–™åº«', 'success');

                // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
                document.getElementById('btnTestFCM').disabled = false;
                document.getElementById('btnTestMedicationReminder').disabled = false;

            } catch (error) {
                log('è¨»å†Š Token å¤±æ•—: ' + error.message, 'error');
                alert('è¨»å†Šå¤±æ•—: ' + error.message);
            }
        }

        // 8. æ¸¬è©¦ FCM æ¨é€
        async function testFCMPush() {
            try {
                if (!currentElderId) {
                    alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿ');
                    return;
                }

                log('æ­£åœ¨ç™¼é€æ¸¬è©¦æ¨é€...', 'info');

                const response = await fetch('http://localhost:3000/api/fcm/test-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        elderId: currentElderId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                log('âœ… æ¸¬è©¦æ¨é€å·²ç™¼é€ï¼è«‹æŸ¥çœ‹é€šçŸ¥å€åŸŸ', 'success');
                alert('âœ… æ¸¬è©¦æ¨é€å·²ç™¼é€ï¼\n\nè«‹æŸ¥çœ‹è¢å¹•å³ä¸‹è§’ï¼ˆWindowsï¼‰æˆ–å³ä¸Šè§’ï¼ˆMacï¼‰çš„é€šçŸ¥å€åŸŸ');

            } catch (error) {
                log('ç™¼é€æ¸¬è©¦æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('ç™¼é€å¤±æ•—: ' + error.message);
            }
        }

        // 9. æ¸¬è©¦ç”¨è—¥æé†’æ¨é€
        async function testMedicationReminderPush() {
            try {
                if (!currentElderId) {
                    alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿ');
                    return;
                }

                log('æ­£åœ¨ç™¼é€ç”¨è—¥æé†’æ¨é€...', 'info');

                const response = await fetch('http://localhost:3000/api/fcm/test-medication-reminder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        elderId: currentElderId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                log('âœ… ç”¨è—¥æé†’æ¨é€å·²ç™¼é€ï¼', 'success');
                alert('âœ… ç”¨è—¥æé†’æ¨é€å·²ç™¼é€ï¼\n\nè«‹æŸ¥çœ‹é€šçŸ¥å€åŸŸ');

            } catch (error) {
                log('ç™¼é€ç”¨è—¥æé†’æ¨é€å¤±æ•—: ' + error.message, 'error');
                alert('ç™¼é€å¤±æ•—: ' + error.message);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            log('=== FCM æ¸¬è©¦å·¥å…·å•Ÿå‹• ===', 'info');

            // åŸ·è¡Œæª¢æŸ¥
            const browserOK = checkBrowserSupport();
            checkNotificationPermission();
            await checkServiceWorker();
            await getElderInfo();

            if (browserOK) {
                await initFirebase();
            }

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            document.getElementById('btnGetToken').addEventListener('click', getFCMToken);
            document.getElementById('btnRegisterToken').addEventListener('click', registerTokenToDatabase);
            document.getElementById('btnTestFCM').addEventListener('click', testFCMPush);
            document.getElementById('btnTestMedicationReminder').addEventListener('click', testMedicationReminderPush);

            log('=== æª¢æŸ¥å®Œæˆï¼Œè«‹ä¾åºé»æ“ŠæŒ‰éˆ•é€²è¡Œæ¸¬è©¦ ===', 'success');
        });
    </script>
</body>
</html>
