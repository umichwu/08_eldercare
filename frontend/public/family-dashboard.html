<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家屬監控面板 - ElderCare</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles-modern.css">
    <link rel="stylesheet" href="mobile-modern.css">
    <link rel="stylesheet" href="family-dashboard.css">

    <!-- Leaflet 地圖 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="top-nav">
        <button class="nav-back" onclick="window.location.href='index.html'">
            ← 返回
        </button>
        <h1 class="nav-title">👨‍👩‍👧 家屬監控面板</h1>
        <div class="nav-actions">
            <button class="nav-help" onclick="window.location.href='test-family-dashboard-filter.html'" title="測試指南">
                📖
            </button>
            <button class="nav-settings" onclick="showSettings()">
                ⚙️
            </button>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="dashboard-container">
        <!-- 長輩選擇器 -->
        <div class="elder-selector">
            <label for="elderSelect">選擇長輩：</label>
            <select id="elderSelect" onchange="switchElder(this.value)">
                <option value="">載入中...</option>
            </select>
        </div>

        <!-- 標籤切換 -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
                📊 總覽
            </button>
            <button class="tab-btn" data-tab="medication" onclick="switchTab('medication')">
                💊 用藥記錄
            </button>
            <button class="tab-btn" data-tab="conversations" onclick="switchTab('conversations')">
                💬 對話記錄
            </button>
            <button class="tab-btn" data-tab="alerts" onclick="switchTab('alerts')">
                🔔 警示
            </button>
            <button class="tab-btn" data-tab="geolocation" onclick="switchTab('geolocation')">
                📍 位置追蹤
            </button>
        </div>

        <!-- 總覽標籤 -->
        <div id="overview-tab" class="tab-content active">
            <!-- 關鍵指標卡片 -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">💊</div>
                    <div class="metric-content">
                        <div class="metric-label">今日用藥遵從率</div>
                        <div class="metric-value" id="todayAdherence">--%</div>
                        <div class="metric-trend" id="adherenceTrend"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">💬</div>
                    <div class="metric-content">
                        <div class="metric-label">今日對話次數</div>
                        <div class="metric-value" id="todayConversations">--</div>
                        <div class="metric-trend" id="conversationsTrend"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">🕐</div>
                    <div class="metric-content">
                        <div class="metric-label">最後活動時間</div>
                        <div class="metric-value" id="lastActivity">--</div>
                        <div class="metric-trend" id="activityStatus"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">⚠️</div>
                    <div class="metric-content">
                        <div class="metric-label">待處理警示</div>
                        <div class="metric-value" id="pendingAlerts">--</div>
                        <div class="metric-trend" id="alertsTrend"></div>
                    </div>
                </div>
            </div>

            <!-- 用藥遵從趨勢圖 -->
            <div class="chart-card">
                <h3>📈 用藥遵從趨勢（最近 7 天）</h3>
                <canvas id="adherenceChart"></canvas>
            </div>

            <!-- 活動狀態 -->
            <div class="activity-card">
                <h3>📅 最近活動</h3>
                <div id="recentActivity" class="activity-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用藥記錄標籤 -->
        <div id="medication-tab" class="tab-content">
            <div class="filter-bar">
                <select id="medicationFilter" onchange="filterMedicationLogs(this.value)">
                    <option value="all">全部記錄</option>
                    <option value="taken">已服用</option>
                    <option value="missed">已錯過</option>
                    <option value="late">遲服用</option>
                </select>
                <input type="date" id="dateFilter" onchange="filterByDate(this.value)">
            </div>

            <!-- 用藥記錄列表 -->
            <div id="medicationLogs" class="medication-logs">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入用藥記錄...</p>
                </div>
            </div>

            <!-- 用藥統計 -->
            <div class="stats-card">
                <h3>📊 用藥統計（最近 30 天）</h3>
                <div class="stats-grid" id="medicationStats">
                    <!-- 動態載入 -->
                </div>
            </div>
        </div>

        <!-- 對話記錄標籤 -->
        <div id="conversations-tab" class="tab-content">
            <div class="filter-bar">
                <input type="date" id="conversationDateFilter" onchange="filterConversations(this.value)">
                <button class="btn-secondary" onclick="loadConversations()">
                    🔄 重新整理
                </button>
            </div>

            <!-- 對話列表 -->
            <div id="conversationsList" class="conversations-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入對話記錄...</p>
                </div>
            </div>
        </div>

        <!-- 警示標籤 -->
        <div id="alerts-tab" class="tab-content">
            <div class="filter-bar">
                <select id="alertTypeFilter" onchange="filterAlerts(this.value)">
                    <option value="all">全部警示</option>
                    <option value="medication">用藥相關</option>
                    <option value="health">健康異常</option>
                    <option value="activity">活動異常</option>
                    <option value="emergency">緊急求助</option>
                </select>
                <select id="alertStatusFilter" onchange="filterAlerts()">
                    <option value="pending">待處理</option>
                    <option value="all">全部狀態</option>
                    <option value="resolved">已處理</option>
                </select>
            </div>

            <!-- 警示列表 -->
            <div id="alertsList" class="alerts-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入警示...</p>
                </div>
            </div>
        </div>

        <!-- 地理位置標籤 -->
        <div id="geolocation-tab" class="tab-content">
            <div class="geolocation-header">
                <button class="btn-primary" onclick="window.location.href='geolocation.html'">
                    ⚙️ 管理安全區域
                </button>
                <button class="btn-secondary" onclick="refreshLocation()">
                    🔄 更新位置
                </button>
            </div>

            <!-- 當前位置卡片 -->
            <div class="location-card">
                <h3>📍 當前位置</h3>
                <div id="currentLocation" class="current-location">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入位置資訊...</p>
                    </div>
                </div>
            </div>

            <!-- 地圖顯示 -->
            <div class="map-card">
                <h3>🗺️ 地圖</h3>
                <div id="locationMap" style="height: 400px; border-radius: 12px; overflow: hidden;">
                    <!-- Leaflet 地圖將在此載入 -->
                </div>
            </div>

            <!-- 安全區域列表 -->
            <div class="safe-zones-card">
                <h3>🛡️ 安全區域</h3>
                <div id="safeZonesList" class="safe-zones-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入安全區域...</p>
                    </div>
                </div>
            </div>

            <!-- 地理圍欄警示 -->
            <div class="geofence-alerts-card">
                <h3>🚨 地理圍欄警示</h3>
                <div id="geofenceAlertsList" class="geofence-alerts-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入警示記錄...</p>
                    </div>
                </div>
            </div>

            <!-- 位置歷史 -->
            <div class="location-history-card">
                <h3>📜 位置歷史（最近 24 小時）</h3>
                <div id="locationHistoryList" class="location-history-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入歷史記錄...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 對話詳情 Modal -->
    <div id="conversationModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>💬 對話詳情</h2>
                <button class="modal-close" onclick="closeConversationModal()">&times;</button>
            </div>
            <div id="conversationDetail" class="conversation-detail">
                <!-- 動態載入 -->
            </div>
        </div>
    </div>

    <!-- 警示詳情 Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔔 警示詳情</h2>
                <button class="modal-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div id="alertDetail" class="alert-detail">
                <!-- 動態載入 -->
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="markAlertAsResolved()">
                    ✓ 標記為已處理
                </button>
                <button class="btn-secondary" onclick="closeAlertModal()">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="family-dashboard.js"></script>
</body>
</html>
