<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家屬監控面板 - ElderCare</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles-modern.css">
    <link rel="stylesheet" href="mobile-modern.css">
    <link rel="stylesheet" href="family-dashboard.css">

    <!-- Leaflet 地圖 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- 全域快捷鍵 -->
    <script src="keyboard-shortcuts.js"></script>

    <!-- 麵包屑導航 -->
    <script src="breadcrumb-navigation.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="top-nav">
        <button class="nav-back" onclick="window.location.href='medications.html'">
            ← 返回
        </button>
        <h1 class="nav-title">👨‍👩‍👧 家屬監控面板</h1>
        <div class="nav-actions">
            <button class="nav-download-app" onclick="downloadAndroidApp()" title="下載 Android App" style="
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                color: white;
                font-size: 20px;
                border: none;
                border-radius: 8px;
                padding: 8px 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 10px rgba(76, 175, 80, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(76, 175, 80, 0.3)'">
                📱
            </button>
            <button class="nav-help" onclick="window.location.href='test-family-dashboard-filter.html'" title="測試指南">
                📖
            </button>
            <button class="nav-settings" onclick="showSettings()">
                ⚙️
            </button>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="dashboard-container">
        <!-- 長輩選擇器 -->
        <div class="elder-selector">
            <label for="elderSelect">選擇長輩：</label>
            <select id="elderSelect" onchange="switchElder(this.value)">
                <option value="">載入中...</option>
            </select>
        </div>

        <!-- 標籤切換 -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
                📊 總覽
            </button>
            <button class="tab-btn" data-tab="medication" onclick="switchTab('medication')">
                💊 用藥記錄
            </button>
            <button class="tab-btn" data-tab="conversations" onclick="switchTab('conversations')">
                💬 對話記錄
            </button>
            <button class="tab-btn" data-tab="alerts" onclick="switchTab('alerts')">
                🔔 警示
            </button>
            <button class="tab-btn" data-tab="geolocation" onclick="switchTab('geolocation')">
                📍 位置追蹤
            </button>
        </div>

        <!-- 總覽標籤 -->
        <div id="overview-tab" class="tab-content active">
            <!-- 關鍵指標卡片 -->
            <div class="metrics-grid">
                <div class="metric-card clickable" onclick="showTodayMedicationDetail()" style="cursor: pointer;">
                    <div class="metric-icon">💊</div>
                    <div class="metric-content">
                        <div class="metric-label">今日用藥遵從率 <span style="font-size: 12px; opacity: 0.7;">（點擊查看詳情）</span></div>
                        <div class="metric-value" id="todayAdherence">--%</div>
                        <div class="metric-trend" id="adherenceTrend"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">💬</div>
                    <div class="metric-content">
                        <div class="metric-label">今日對話次數</div>
                        <div class="metric-value" id="todayConversations">--</div>
                        <div class="metric-trend" id="conversationsTrend"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">🕐</div>
                    <div class="metric-content">
                        <div class="metric-label">最後活動時間</div>
                        <div class="metric-value" id="lastActivity">--</div>
                        <div class="metric-trend" id="activityStatus"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">⚠️</div>
                    <div class="metric-content">
                        <div class="metric-label">待處理警示</div>
                        <div class="metric-value" id="pendingAlerts">--</div>
                        <div class="metric-trend" id="alertsTrend"></div>
                    </div>
                </div>
            </div>

            <!-- 用藥遵從趨勢圖 -->
            <div class="chart-card">
                <h3>📈 用藥遵從趨勢（最近 7 天）</h3>
                <canvas id="adherenceChart"></canvas>
            </div>

            <!-- 活動狀態 -->
            <div class="activity-card">
                <h3>📅 最近活動</h3>
                <div id="recentActivity" class="activity-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用藥記錄標籤 -->
        <div id="medication-tab" class="tab-content">
            <div class="filter-bar">
                <select id="medicationFilter" onchange="filterMedicationLogs(this.value)">
                    <option value="all">全部記錄</option>
                    <option value="taken">已服用</option>
                    <option value="missed">已錯過</option>
                    <option value="late">遲服用</option>
                </select>
                <input type="date" id="dateFilter" onchange="filterByDate(this.value)">
            </div>

            <!-- 用藥記錄列表 -->
            <div id="medicationLogs" class="medication-logs">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入用藥記錄...</p>
                </div>
            </div>

            <!-- 用藥統計 -->
            <div class="stats-card">
                <h3>📊 用藥統計（最近 30 天）</h3>
                <div class="stats-grid" id="medicationStats">
                    <!-- 動態載入 -->
                </div>
            </div>
        </div>

        <!-- 對話記錄標籤 -->
        <div id="conversations-tab" class="tab-content">
            <div class="filter-bar">
                <input type="date" id="conversationDateFilter" onchange="filterConversations(this.value)">
                <button class="btn-secondary" onclick="loadConversations()">
                    🔄 重新整理
                </button>
            </div>

            <!-- 對話列表 -->
            <div id="conversationsList" class="conversations-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入對話記錄...</p>
                </div>
            </div>
        </div>

        <!-- 警示標籤 -->
        <div id="alerts-tab" class="tab-content">
            <div class="filter-bar">
                <select id="alertTypeFilter" onchange="filterAlerts(this.value)">
                    <option value="all">全部警示</option>
                    <option value="medication">用藥相關</option>
                    <option value="health">健康異常</option>
                    <option value="activity">活動異常</option>
                    <option value="emergency">緊急求助</option>
                </select>
                <select id="alertStatusFilter" onchange="filterAlerts()">
                    <option value="pending">待處理</option>
                    <option value="all">全部狀態</option>
                    <option value="resolved">已處理</option>
                </select>
            </div>

            <!-- 警示列表 -->
            <div id="alertsList" class="alerts-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入警示...</p>
                </div>
            </div>
        </div>

        <!-- 地理位置標籤 -->
        <div id="geolocation-tab" class="tab-content">
            <!-- 位置追蹤使用說明 -->
            <div class="location-guide" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #2196f3;">
                <h3 style="color: #1565c0; margin-bottom: 15px; font-size: 18px;">📍 位置追蹤功能說明</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #333; margin-bottom: 10px; font-size: 16px;">🎯 功能用途</h4>
                    <ul style="color: #666; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li>即時追蹤長輩的位置，確保安全</li>
                        <li>設定安全區域（如家、醫院、社區活動中心）</li>
                        <li>當長輩離開或進入安全區域時，自動發送警示</li>
                        <li>查看 24 小時位置移動歷史</li>
                    </ul>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #333; margin-bottom: 10px; font-size: 16px;">🔧 如何使用</h4>
                    <ol style="color: #666; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>設定安全區域：</strong>點擊「⚙️ 管理安全區域」按鈕，在地圖上標記重要地點並設定半徑</li>
                        <li><strong>啟用警示：</strong>在安全區域設定中，勾選「離開時警示」或「進入時通知」</li>
                        <li><strong>查看即時位置：</strong>本頁面會顯示長輩最新位置和時間</li>
                        <li><strong>處理警示：</strong>收到地理圍欄警示後，可查看詳情並標記為已處理</li>
                    </ol>
                </div>
            </div>

            <div class="geolocation-header" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="window.location.href='geolocation.html'">
                    ⚙️ 管理安全區域
                </button>
                <button class="btn-secondary" onclick="refreshLocation()">
                    🔄 更新位置
                </button>
                <button class="btn-success" onclick="recordCurrentLocation()" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white;">
                    📍 手動記錄位置
                </button>
            </div>

            <!-- 當前位置卡片 -->
            <div class="location-card">
                <h3>📍 當前位置</h3>
                <div id="currentLocation" class="current-location">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入位置資訊...</p>
                    </div>
                </div>
            </div>

            <!-- 地圖顯示 -->
            <div class="map-card">
                <h3>🗺️ 地圖</h3>
                <div id="locationMap" style="height: 400px; border-radius: 12px; overflow: hidden;">
                    <!-- Leaflet 地圖將在此載入 -->
                </div>
            </div>

            <!-- 安全區域列表 -->
            <div class="safe-zones-card">
                <h3>🛡️ 安全區域</h3>
                <div id="safeZonesList" class="safe-zones-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入安全區域...</p>
                    </div>
                </div>
            </div>

            <!-- 地理圍欄警示 -->
            <div class="geofence-alerts-card">
                <h3>🚨 地理圍欄警示</h3>
                <div id="geofenceAlertsList" class="geofence-alerts-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入警示記錄...</p>
                    </div>
                </div>
            </div>

            <!-- 位置歷史 -->
            <div class="location-history-card">
                <h3>📜 位置歷史（最近 24 小時）</h3>
                <div id="locationHistoryList" class="location-history-list">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入歷史記錄...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 今日用藥詳情 Modal -->
    <div id="todayMedicationModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>💊 今日用藥詳情</h2>
                <button class="modal-close" onclick="closeTodayMedicationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="todayMedicationDetail" style="padding: 20px;">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>載入今日用藥記錄...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 對話詳情 Modal -->
    <div id="conversationModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>💬 對話詳情</h2>
                <button class="modal-close" onclick="closeConversationModal()">&times;</button>
            </div>
            <div id="conversationDetail" class="conversation-detail">
                <!-- 動態載入 -->
            </div>
        </div>
    </div>

    <!-- 警示詳情 Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔔 警示詳情</h2>
                <button class="modal-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div id="alertDetail" class="alert-detail">
                <!-- 動態載入 -->
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="markAlertAsResolved()">
                    ✓ 標記為已處理
                </button>
                <button class="btn-secondary" onclick="closeAlertModal()">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- 設定 Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>⚙️ 監控面板設定</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 設定說明 -->
                <div class="settings-guide">
                    <h3>📖 如何使用家屬監控面板</h3>
                    <div class="guide-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>建立家屬帳號</h4>
                            <p>在登入頁面註冊時，選擇「家屬」角色</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>建立與長輩的關聯</h4>
                            <p>使用下方的「關聯長輩」功能，選擇要監控的長輩</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>監控長輩狀況</h4>
                            <p>在面板上查看用藥記錄、對話記錄、警示等資訊</p>
                        </div>
                    </div>
                </div>

                <!-- 關聯長輩管理 -->
                <div class="settings-section">
                    <h3>👨‍👩‍👧 關聯長輩管理</h3>

                    <!-- 已關聯的長輩列表 -->
                    <div class="linked-elders-list" id="linkedEldersList">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>載入中...</p>
                        </div>
                    </div>

                    <!-- 新增關聯按鈕 -->
                    <button class="btn-primary" onclick="showLinkElderForm()">
                        ➕ 新增長輩關聯
                    </button>
                </div>

                <!-- 監控 SOP 指南 -->
                <div class="settings-section">
                    <h3>📋 監控 SOP 指南</h3>
                    <div class="sop-guide">
                        <div class="sop-item">
                            <div class="sop-icon">💊</div>
                            <div class="sop-content">
                                <h4>用藥監控</h4>
                                <ul>
                                    <li>每天檢查「總覽」頁的用藥遵從率</li>
                                    <li>遵從率 < 70% 時主動聯繫長輩</li>
                                    <li>檢查「用藥記錄」頁的錯過次數</li>
                                </ul>
                            </div>
                        </div>
                        <div class="sop-item">
                            <div class="sop-icon">🔔</div>
                            <div class="sop-content">
                                <h4>警示處理</h4>
                                <ul>
                                    <li>每天至少檢查一次「警示」頁</li>
                                    <li>緊急警示立即處理</li>
                                    <li>處理後標記為「已處理」</li>
                                </ul>
                            </div>
                        </div>
                        <div class="sop-item">
                            <div class="sop-icon">💬</div>
                            <div class="sop-content">
                                <h4>對話監控</h4>
                                <ul>
                                    <li>檢查對話記錄是否有異常問題</li>
                                    <li>關注重複詢問相同問題的情況</li>
                                    <li>如有健康相關詢問，主動關心</li>
                                </ul>
                            </div>
                        </div>
                        <div class="sop-item">
                            <div class="sop-icon">📍</div>
                            <div class="sop-content">
                                <h4>位置追蹤</h4>
                                <ul>
                                    <li>設定安全區域（家、社區等）</li>
                                    <li>啟用離開安全區域警示</li>
                                    <li>定期檢查位置歷史記錄</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 關聯長輩 Modal -->
    <div id="linkElderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ 關聯長輩</h2>
                <button class="modal-close" onclick="closeLinkElderModal()">&times;</button>
            </div>
            <form id="linkElderForm" onsubmit="submitLinkElder(event)">
                <div class="form-group">
                    <label for="elderSelectForLink">選擇長輩：</label>
                    <select id="elderSelectForLink" required>
                        <option value="">載入中...</option>
                    </select>
                    <small>選擇系統中已註冊的長輩帳號</small>
                </div>

                <div class="form-group">
                    <label for="relationshipType">關係：</label>
                    <select id="relationshipType" required>
                        <option value="">請選擇</option>
                        <option value="子女">子女</option>
                        <option value="配偶">配偶</option>
                        <option value="孫子女">孫子女</option>
                        <option value="兄弟姊妹">兄弟姊妹</option>
                        <option value="其他親屬">其他親屬</option>
                        <option value="照護者">照護者</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">確認關聯</button>
                    <button type="button" class="btn-secondary" onclick="closeLinkElderModal()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <!-- Scripts (按順序載入) -->
    <!-- 1. 全域配置 (最優先) -->
    <script src="config.js"></script>

    <!-- 2. Android App 偵測 -->
    <script src="app-detection.js"></script>

    <!-- 3. 主要功能腳本 -->
    <script src="family-dashboard.js"></script>
</body>
</html>
