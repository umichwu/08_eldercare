<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI驅動的長輩陪伴聊天系統">
    <meta name="theme-color" content="#667eea">
    <title>長輩陪伴助手 - ElderCare Companion</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- Styles - Modern Design -->
    <link rel="stylesheet" href="styles-modern.css">
    <!-- Fallback to old styles -->
    <!-- <link rel="stylesheet" href="styles.css"> -->

    <!-- 初始載入樣式 - 防止白屏/黑屏 -->
    <style>
        /* 初始載入畫面 */
        #initialLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0A0A0F 0%, #1E1E24 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease-out;
        }

        #initialLoader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-logo {
            font-size: 64px;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .loader-text {
            color: #E8EAED;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 32px;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(10, 132, 255, 0.2);
            border-top-color: #0A84FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* 確保 app 在載入時不顯示 */
        #app {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        #app.loaded {
            opacity: 1;
        }
    </style>

    <!-- 裝置偵測與行動版樣式 - Modern -->
    <link rel="stylesheet" href="mobile-modern.css">
    <!-- Old mobile styles -->
    <!-- <link rel="stylesheet" href="mobile.css"> -->
    <script src="device-detector.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 初始載入畫面 -->
    <div id="initialLoader">
        <div class="loader-logo">🏥</div>
        <div class="loader-text">長輩陪伴助手</div>
        <div class="loader-spinner"></div>
    </div>

    <!-- 主容器 -->
    <div id="app">
        <!-- 頭部區域 -->
        <header class="app-header">
            <!-- 行動版漢堡選單按鈕 -->
            <button id="mobileMenuBtn" class="mobile-menu-btn" title="選單">
                ☰
            </button>
            <h1 class="app-title" data-i18n="app.title">🏥 長輩陪伴助手</h1>
            <div class="header-controls">
                <!-- 使用者資訊 -->
                <div id="userInfo" class="user-info" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="" alt="頭像">
                    <span id="userName" class="user-name"></span>
                </div>

                <button id="voiceToggle" class="icon-btn" data-i18n-title="header.voiceToggle" title="語音開關">
                    🔊
                </button>
                <button id="settingsBtn" class="icon-btn" data-i18n-title="header.settings" title="設定">
                    ⚙️
                </button>
                <button id="logoutBtn" class="icon-btn" data-i18n-title="header.logout" title="登出" style="display: none;">
                    🚪
                </button>
            </div>
        </header>

        <!-- 側邊欄遮罩（用於行動版） -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- 主要內容區 -->
        <main class="app-main">
            <!-- 左側：對話列表 -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 data-i18n="sidebar.title">對話記錄</h2>
                    <button id="newChatBtn" class="btn btn-primary" data-i18n="sidebar.newChat">
                        ➕ 新對話
                    </button>
                </div>
                <div id="conversationList" class="conversation-list">
                    <!-- 動態載入對話列表 -->
                </div>
            </aside>

            <!-- 中間：聊天區域 -->
            <section class="chat-container">
                <!-- 歡迎畫面 -->
                <div id="welcomeScreen" class="welcome-screen">
                    <div class="welcome-content">
                        <h2 class="welcome-title" data-i18n="welcome.title">您好！我是您的陪伴助手 😊</h2>
                        <p class="welcome-subtitle" data-i18n="welcome.subtitle">有什麼我可以幫您的嗎？</p>

                        <!-- 快速功能按鈕（行動版） -->
                        <button id="quickFunctionsBtn" class="quick-functions-btn mobile-only">
                            ⚡ 快速功能
                        </button>

                        <!-- 桌面版：顯示所有按鈕 -->
                        <div class="quick-actions desktop-only">
                            <button class="quick-btn" data-message="今天天氣如何？" data-i18n="quickAction.weather">
                                ☀️ 天氣查詢
                            </button>
                            <button class="quick-btn" data-message="提醒我吃藥" data-i18n="quickAction.medication">
                                💊 用藥提醒
                            </button>
                            <button class="quick-btn" data-message="講個笑話給我聽" data-i18n="quickAction.joke">
                                😄 聽笑話
                            </button>
                            <button class="quick-btn" data-message="我覺得有點不舒服" data-i18n="quickAction.health">
                                🏥 健康諮詢
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 聊天訊息區 -->
                <div id="chatMessages" class="chat-messages">
                    <!-- 動態載入訊息 -->
                </div>

                <!-- 輸入區域 -->
                <div class="input-container">
                    <!-- 快捷功能按鈕 -->
                    <div class="quick-shortcuts">
                        <button class="shortcut-btn" data-message="quickMessage.weather" data-i18n="quickAction.weather">
                            ☀️ 天氣
                        </button>
                        <button class="shortcut-btn" data-message="quickMessage.medication" data-i18n="quickAction.medication">
                            💊 用藥
                        </button>
                        <button class="shortcut-btn" data-message="quickMessage.joke" data-i18n="quickAction.joke">
                            😄 笑話
                        </button>
                        <button class="shortcut-btn" data-message="quickMessage.health" data-i18n="quickAction.health">
                            🏥 健康
                        </button>
                    </div>

                    <!-- SOS 緊急按鈕 -->
                    <button id="sosBtn" class="sos-btn" data-i18n="input.sos">
                        🆘 緊急求助
                    </button>

                    <!-- 訊息輸入框 -->
                    <div class="input-wrapper">
                        <textarea
                            id="messageInput"
                            class="message-input"
                            placeholder="請輸入訊息..."
                            rows="2"
                        ></textarea>
                        <div class="input-controls">
                            <button id="voiceInputBtn" class="btn btn-voice" data-i18n="input.voiceInput">
                                🎤 語音輸入
                            </button>
                            <button id="sendBtn" class="btn btn-send" data-i18n="input.send">
                                ➤ 傳送
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 右側：總結和資訊 -->
            <aside class="info-panel">
                <div class="panel-section">
                    <h3 data-i18n="panel.summary">💡 對話摘要</h3>
                    <div id="summaryContent" class="summary-content">
                        <p class="empty-state" data-i18n="panel.emptySummary">尚無對話摘要</p>
                    </div>
                    <button id="generateSummaryBtn" class="btn btn-secondary" style="display: none;" data-i18n="panel.generateSummary">
                        產生摘要
                    </button>
                </div>

                <div class="panel-section">
                    <h3 data-i18n="panel.statistics">📊 統計資訊</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-label" data-i18n="panel.totalMessages">訊息數量</span>
                            <span id="messageCount" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-i18n="panel.untilSummary">距離總結</span>
                            <span id="summaryProgress" class="stat-value">0/20</span>
                        </div>
                    </div>
                </div>

                <!-- 調試面板 -->
                <div class="panel-section" style="background: #f0f8ff; border: 2px solid #4a90e2;">
                    <h3>🔍 系統狀態 (調試模式)</h3>
                    <div class="debug-info" style="font-size: 12px; font-family: monospace;">
                        <div style="margin: 5px 0;">
                            <strong>使用者 ID:</strong>
                            <span id="debugUserId" style="color: #d63031;">未初始化</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>當前對話:</strong>
                            <span id="debugConversation" style="color: #d63031;">無</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>應用狀態:</strong>
                            <span id="debugAppStatus" style="color: #d63031;">未初始化</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>按鈕綁定:</strong>
                            <span id="debugButtonStatus" style="color: #d63031;">未綁定</span>
                        </div>
                        <div style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #ddd;">
                            <button onclick="testSendButton()" class="btn btn-secondary" style="width: 100%; font-size: 14px;">
                                🧪 測試傳送按鈕
                            </button>
                        </div>
                        <div style="margin: 10px 0;">
                            <button onclick="showConsoleInstructions()" class="btn btn-secondary" style="width: 100%; font-size: 14px;">
                                📋 如何查看 Console
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- 載入指示器 -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text">處理中，請稍候...</p>
        </div>

        <!-- SOS 確認對話框 -->
        <div id="sosModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="modal-title">🆘 緊急求助</h2>
                <p class="modal-text">確定要發送緊急通知給家人嗎？</p>
                <div class="modal-actions">
                    <button id="sosConfirmBtn" class="btn btn-danger">
                        確認發送
                    </button>
                    <button id="sosCancelBtn" class="btn btn-secondary">
                        取消
                    </button>
                </div>
            </div>
        </div>

        <!-- 快速功能選單（行動版） -->
        <div id="quickFunctionsModal" class="modal quick-functions-modal" style="display: none;">
            <div class="modal-content quick-functions-content">
                <h2 class="modal-title">⚡ 快速功能</h2>
                <div class="quick-functions-list">
                    <button class="quick-function-item" data-message="今天天氣如何？">
                        <span class="quick-icon">☀️</span>
                        <span class="quick-text">天氣查詢</span>
                    </button>
                    <button class="quick-function-item" data-message="提醒我吃藥">
                        <span class="quick-icon">💊</span>
                        <span class="quick-text">用藥提醒</span>
                    </button>
                    <button class="quick-function-item" data-message="講個笑話給我聽">
                        <span class="quick-icon">😄</span>
                        <span class="quick-text">聽笑話</span>
                    </button>
                    <button class="quick-function-item" data-message="我覺得有點不舒服">
                        <span class="quick-icon">🏥</span>
                        <span class="quick-text">健康諮詢</span>
                    </button>
                    <button class="quick-function-item" id="sosQuickBtn">
                        <span class="quick-icon">🆘</span>
                        <span class="quick-text">緊急求助</span>
                    </button>
                </div>
                <button id="closeQuickFunctionsBtn" class="btn btn-secondary">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===================================
        // 裝置偵測初始化 - 最優先執行
        // ===================================

        // 初始化裝置偵測和 UI 適配
        // 注意：在主應用頁面，我們只需要檢測裝置類型，不需要處理 LINE 瀏覽器
        // （因為 OAuth 認證已經在 login.html 完成）
        initDeviceDetection({
            checkLINE: false,       // 主應用不需要檢查 LINE（認證已完成）
            autoRedirect: false,    // 不需要重導向
            loadMobileCSS: true,    // 載入行動版 CSS
            logDeviceInfo: true     // 輸出裝置資訊到 console
        });

        // 輸出裝置類型供應用程式使用
        const DEVICE_TYPE = DeviceDetector.getDeviceType();
        const IS_MOBILE = DeviceDetector.isMobile();
        console.log(`📱 當前裝置類型: ${DEVICE_TYPE}, 行動裝置: ${IS_MOBILE}`);

        // ===================================
        // PWA Service Worker Registration
        // ===================================
        // 暫時禁用 Service Worker 以診斷問題
        console.log('⚠️ Service Worker 已暫時禁用，用於診斷問題');
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('🔄 New Service Worker found, installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New service worker available, but don't auto-reload
                                        console.log('✨ New version available! Reload to update.');
                                        // Optional: Show a subtle notification to user
                                        // For now, just log it to avoid infinite reload
                                    } else {
                                        // First time install
                                        console.log('✅ Service Worker installed for the first time');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('❌ Service Worker registration failed:', error);
                    });
            });

            // Handle service worker updates - removed auto-reload to prevent infinite loop
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    console.log('🔄 Service Worker controller changed');
                    // Don't auto-reload, let user decide
                    // window.location.reload();
                }
            });
        }
        */

        // ===================================
        // PWA Install Prompt
        // ===================================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button (you can add this to UI later)
            console.log('💡 PWA installation available');
        });

        // ===================================
        // Authentication Check
        // ===================================
        const SUPABASE_URL = 'https://oatdjdelzybcacwqafkk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hdGRqZGVsenliY2Fjd3FhZmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDM5ODUsImV4cCI6MjA3Njc3OTk4NX0.Flk-9yHREG7gWr1etG-TEc2ufPjP-zvW2Ejd2gCqG4w';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global user info
        let currentUser = null;
        let userProfile = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                console.log('🔍 開始檢查認證...');
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('❌ Auth check error:', error);
                    alert('認證檢查失敗：' + error.message);
                    redirectToLogin();
                    return false;
                }

                if (!session) {
                    console.log('⚠️ No active session, redirecting to login...');
                    redirectToLogin();
                    return false;
                }

                currentUser = session.user;
                console.log('✅ User authenticated:', currentUser.email);
                console.log('👤 User ID:', currentUser.id);

                // Load user profile
                console.log('📥 載入使用者資料...');
                const profileLoaded = await loadUserProfile();

                if (!profileLoaded) {
                    console.error('❌ 無法載入使用者資料');
                    alert('無法載入使用者資料，請重新登入');
                    return false;
                }

                // Display user info
                displayUserInfo();

                console.log('✅ 認證檢查完成');
                return true;
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                alert('系統錯誤：' + error.message);
                redirectToLogin();
                return false;
            }
        }

        // Load user profile from database
        async function loadUserProfile() {
            try {
                console.log('🔍 查詢 user_profiles 表格...');
                console.log('   auth_user_id:', currentUser.id);

                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('auth_user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('❌ Failed to load user profile:', error);
                    console.error('   錯誤代碼:', error.code);
                    console.error('   錯誤訊息:', error.message);

                    // Check if onboarding not completed
                    if (error.code === 'PGRST116') {
                        console.log('⚠️ User profile not found, redirecting to onboarding...');
                        alert('找不到使用者資料，將轉到設定頁面');
                        window.location.href = '/onboarding.html';
                        return false;
                    }

                    alert('載入使用者資料失敗：' + error.message);
                    return false;
                }

                if (!data) {
                    console.error('❌ User profile data is null');
                    alert('使用者資料為空，請重新註冊');
                    return false;
                }

                userProfile = data;
                console.log('✅ User profile loaded:', userProfile);
                console.log('   ID:', userProfile.id);
                console.log('   Name:', userProfile.display_name);
                console.log('   Onboarding completed:', userProfile.onboarding_completed);

                // Check if onboarding completed
                if (!userProfile.onboarding_completed) {
                    console.log('⚠️ Onboarding not completed, redirecting...');
                    alert('請先完成初始設定');
                    window.location.href = '/onboarding.html';
                    return false;
                }

                return true;

            } catch (error) {
                console.error('❌ Error loading profile:', error);
                alert('載入使用者資料時發生錯誤：' + error.message);
                return false;
            }
        }

        // Display user information
        function displayUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const logoutBtn = document.getElementById('logoutBtn');

            if (userProfile) {
                // Show user info
                userName.textContent = userProfile.display_name || currentUser.email;

                // Set avatar
                if (userProfile.avatar_url) {
                    userAvatar.src = userProfile.avatar_url;
                } else {
                    // Use default avatar based on user's initial
                    const initial = (userProfile.display_name || currentUser.email).charAt(0).toUpperCase();
                    userAvatar.src = `https://ui-avatars.com/api/?name=${initial}&background=667eea&color=fff&size=40`;
                }

                userInfoDiv.style.display = 'flex';
                logoutBtn.style.display = 'block';
            }
        }

        // Logout function
        async function handleLogout() {
            if (confirm('確定要登出嗎？')) {
                try {
                    const { error } = await supabaseClient.auth.signOut();

                    if (error) {
                        console.error('❌ Logout error:', error);
                        alert('登出時發生錯誤');
                        return;
                    }

                    console.log('✅ Logged out successfully');
                    redirectToLogin();
                } catch (error) {
                    console.error('❌ Logout failed:', error);
                    alert('登出失敗');
                }
            }
        }

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = '/login.html';
        }

        // Listen for auth state changes
        // 暫時禁用以避免觸發重載
        /*
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('🔄 Auth state changed:', event);

            if (event === 'SIGNED_OUT') {
                redirectToLogin();
            } else if (event === 'SIGNED_IN') {
                window.location.reload();
            }
        });
        */

        // 隱藏初始載入畫面
        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            const app = document.getElementById('app');

            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }

            if (app) {
                app.classList.add('loaded');
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing ElderCare Companion...');

            try {
                // Check authentication first
                const isAuthenticated = await checkAuth();

                if (!isAuthenticated) {
                    hideInitialLoader();
                    return; // Stop here if not authenticated
                }

                // Setup logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                }

                // Now load the main app
                console.log('✅ Authentication verified, loading main app...');

                // Wait for app.js to load, then initialize with user data
                if (typeof window.initElderCareApp === 'function') {
                    await window.initElderCareApp(currentUser, userProfile);
                    hideInitialLoader();
                } else {
                    console.log('⏳ Waiting for app.js to load...');
                    // Retry after a short delay
                    setTimeout(async () => {
                        if (typeof window.initElderCareApp === 'function') {
                            await window.initElderCareApp(currentUser, userProfile);
                            hideInitialLoader();
                        } else {
                            console.error('❌ Failed to load app.js');
                            hideInitialLoader();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('❌ Initialization error:', error);
                hideInitialLoader();
            }
        });
    </script>

    <!-- i18n & Settings -->
    <script src="i18n.js"></script>
    <script src="settings.js"></script>

    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- Main App Logic -->
    <script src="app.js"></script>
</body>
</html>
