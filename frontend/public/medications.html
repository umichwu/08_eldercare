<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用藥管理 - ElderCare</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles-modern.css">
    <link rel="stylesheet" href="mobile-modern.css">
    <link rel="stylesheet" href="medications.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- 全域快捷鍵 -->
    <script src="keyboard-shortcuts.js"></script>

    <!-- 麵包屑導航 -->
    <script src="breadcrumb-navigation.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="top-nav">
        <button class="nav-back" onclick="window.location.href='index.html'">
            ← 返回
        </button>
        <h1 class="nav-title">💊 用藥管理</h1>
        <div style="display: flex; gap: 8px;">
            <button class="nav-family-dashboard" onclick="window.location.href='family-dashboard.html'" title="家屬監控">
                👨‍👩‍👧
            </button>
            <button class="nav-notification-test" onclick="testNotification()" title="測試推送通知">
                🔔
            </button>
            <button class="nav-settings" onclick="showSettings()">
                ⚙️
            </button>
        </div>
    </nav>

    <!-- 通知權限提示橫幅 -->
    <div id="notificationBanner" class="notification-banner" style="display: none;">
        <div class="banner-content">
            <span class="banner-icon">🔔</span>
            <div class="banner-text">
                <strong>開啟通知權限</strong>
                <p>請允許瀏覽器通知，以便在用藥時間收到提醒</p>
            </div>
            <button class="banner-btn" onclick="requestNotificationPermission()">立即開啟</button>
            <button class="banner-close" onclick="closeBanner()">✕</button>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="medication-container">
        <!-- 標籤切換 -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="medications" onclick="switchTab('medications')">
                ⏰ 設定用藥時間
            </button>
            <button class="tab-btn" data-tab="today" onclick="switchTab('today')">
                📅 今日用藥
            </button>
            <button class="tab-btn" data-tab="stats" onclick="switchTab('stats')">
                📊 統計
            </button>
        </div>

        <!-- 藥物列表標籤 -->
        <div id="medications-tab" class="tab-content active">
            <!-- 快速新增區域 -->
            <div class="quick-add-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 class="section-title">🎯 快速新增常用藥物</h3>
                    <a href="voice-medication.html" class="voice-add-btn" title="使用語音新增">
                        🎤 語音新增
                    </a>
                </div>
                <div class="quick-templates">
                    <button class="template-btn" onclick="useTemplate('blood_pressure')">
                        <span class="template-icon">❤️</span>
                        <span class="template-text">降血壓藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('diabetes')">
                        <span class="template-icon">🩸</span>
                        <span class="template-text">糖尿病藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('heart')">
                        <span class="template-icon">💓</span>
                        <span class="template-text">心臟病藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('pain')">
                        <span class="template-icon">💊</span>
                        <span class="template-text">止痛藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('cold')">
                        <span class="template-icon">🤧</span>
                        <span class="template-text">感冒藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('stomach')">
                        <span class="template-icon">🫃</span>
                        <span class="template-text">胃腸藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('sleep')">
                        <span class="template-icon">😴</span>
                        <span class="template-text">助眠藥</span>
                    </button>
                    <button class="template-btn" onclick="useTemplate('custom')">
                        <span class="template-icon">✏️</span>
                        <span class="template-text">自訂藥物</span>
                    </button>
                </div>
            </div>

            <!-- 搜尋和新增 -->
            <div class="action-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 搜尋藥物名稱..."
                           oninput="searchMedications(this.value)">
                </div>
                <button class="btn-primary btn-large" onclick="showAddMedicationForm()">
                    ➕ 新增用藥時間
                </button>
            </div>

            <!-- 藥物卡片列表 -->
            <div id="medicationsList" class="medications-list">
                <!-- 載入中 -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入中...</p>
                </div>
            </div>

            <!-- 空狀態 -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">⏰</div>
                <h3 class="large-text">還沒有設定用藥時間</h3>
                <p class="large-text">請選擇上方常用藥物，或點擊「新增用藥時間」按鈕</p>
                <button class="btn-primary btn-extra-large" onclick="showAddMedicationForm()">
                    ➕ 開始設定用藥時間
                </button>
            </div>
        </div>

        <!-- 今日用藥標籤 -->
        <div id="today-tab" class="tab-content">
            <div class="today-header">
                <h2>📅 用藥計劃</h2>

                <!-- 日期導航 -->
                <div class="date-navigation">
                    <button class="date-nav-btn" onclick="changeDate(-1)" title="前一天">
                        ◀ 前一天
                    </button>
                    <div class="date-display-container">
                        <p class="today-date" id="todayDate"></p>
                        <input type="date" id="datePicker" class="date-picker" onchange="selectSpecificDate(this.value)">
                    </div>
                    <button class="date-nav-btn" onclick="changeDate(1)" title="後一天">
                        後一天 ▶
                    </button>
                </div>

                <button class="btn-today" onclick="goToToday()" style="margin-top: 12px;">
                    🏠 回到今天
                </button>

                <!-- 手機鬧鐘設定區域（僅在手機上顯示） -->
                <div id="mobileAlarmSection" class="mobile-alarm-section" style="display: none;">
                    <div class="alarm-info-card">
                        <div class="alarm-icon">⏰</div>
                        <div class="alarm-content">
                            <h3>設定手機鬧鐘提醒</h3>
                            <p>系統會根據您的用藥計劃，自動幫您設定手機鬧鐘</p>
                        </div>
                    </div>
                    <button class="btn-primary btn-large" onclick="setupPhoneAlarms()" style="width: 100%; margin-top: 15px;">
                        📱 一鍵設定手機鬧鐘
                    </button>
                    <div class="alarm-guide" style="margin-top: 12px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 14px; color: #856404;">
                        <strong style="color: #856404;">💡 使用說明：</strong>
                        <ul style="margin: 8px 0 0 20px; line-height: 1.8; color: #856404;">
                            <li>點擊按鈕後，系統會列出今日所有用藥時間</li>
                            <li>點擊「⏰ 設定鬧鐘」會顯示鬧鐘資訊</li>
                            <li>請記下時間和藥品，手動在時鐘 App 中設定</li>
                        </ul>
                    </div>
                </div>

                <!-- 桌面版：Google Calendar 同步 -->
                <button id="desktopCalendarBtn" class="btn-secondary" onclick="syncToGoogleCalendar()" style="margin-top: 12px; display: none;">
                    📆 同步到 Google Calendar
                </button>
            </div>

            <!-- 今日統計 -->
            <div class="today-stats">
                <div class="stat-card">
                    <div class="stat-value" id="todayTotal">0</div>
                    <div class="stat-label">總計</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="todayTaken">0</div>
                    <div class="stat-label">已服用</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="todayPending">0</div>
                    <div class="stat-label">待服用</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="todayMissed">0</div>
                    <div class="stat-label">已錯過</div>
                </div>
            </div>

            <!-- 今日時間軸 -->
            <div id="todayTimeline" class="today-timeline">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入今日用藥...</p>
                </div>
            </div>
        </div>

        <!-- 統計標籤 -->
        <div id="stats-tab" class="tab-content">
            <!-- 測試通知區域 -->
            <div class="test-notification-panel">
                <h3 style="margin-bottom: 15px;">🔔 測試推送通知</h3>
                <div class="notification-status" id="notificationStatus">
                    <div class="status-item">
                        <span class="status-label">通知權限：</span>
                        <span class="status-value" id="permissionStatus">檢查中...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Service Worker：</span>
                        <span class="status-value" id="swStatus">檢查中...</span>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="testNotification()" style="flex: 1; min-width: 200px;">
                        🔔 發送測試通知
                    </button>
                    <button class="btn-secondary" onclick="checkNotificationStatus()" style="flex: 1; min-width: 200px;">
                        🔍 檢查通知狀態
                    </button>
                </div>
                <div class="notification-info" style="margin-top: 15px; padding: 12px; background: #f0f8ff; border-radius: 8px; font-size: 14px;">
                    <strong>📌 測試說明：</strong>
                    <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                        <li>點擊「發送測試通知」會立即發送一個用藥提醒通知</li>
                        <li>測試通知包含快速操作按鈕：✅ 已服用、⏰ 延後、❌ 跳過</li>
                        <li>請確保已允許瀏覽器通知權限</li>
                        <li>如果看不到通知，請檢查瀏覽器的通知設定</li>
                    </ul>
                </div>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

            <div class="stats-header">
                <h2>📊 用藥統計</h2>
                <select id="statsPeriod" onchange="loadStatistics(this.value)">
                    <option value="7">過去 7 天</option>
                    <option value="14">過去 14 天</option>
                    <option value="30">過去 30 天</option>
                </select>
            </div>

            <!-- 統計卡片 -->
            <div id="statisticsCards" class="statistics-cards">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>載入統計資料...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯藥物 Modal (老人家友善版) -->
    <div id="medicationModal" class="modal">
        <div class="modal-content modal-large elder-friendly">
            <div class="modal-header">
                <h2 id="modalTitle" class="large-text">➕ 新增用藥時間</h2>
                <button class="modal-close large-btn" onclick="closeMedicationModal()">&times;</button>
            </div>
            <form id="medicationForm" onsubmit="saveMedication(event)">
                <!-- 基本資訊 (簡化版) -->
                <div class="form-section elder-form">
                    <h3 class="section-title">📋 藥物資訊</h3>

                    <!-- 藥物名稱 -->
                    <div class="form-group-large">
                        <label for="medicationName" class="large-label">
                            <span class="label-icon">💊</span>
                            <span>藥物名稱</span>
                        </label>
                        <select id="medicationNameSelect" class="large-select" onchange="selectMedicationName(this.value)">
                            <option value="">請選擇常用藥物</option>
                            <optgroup label="慢性病藥物">
                                <option value="降血壓藥">降血壓藥</option>
                                <option value="降血糖藥">降血糖藥</option>
                                <option value="心臟病藥">心臟病藥</option>
                                <option value="降血脂藥">降血脂藥</option>
                                <option value="抗凝血藥">抗凝血藥</option>
                            </optgroup>
                            <optgroup label="常見藥物">
                                <option value="感冒藥">感冒藥</option>
                                <option value="止痛藥">止痛藥</option>
                                <option value="消炎藥">消炎藥</option>
                                <option value="胃藥">胃藥</option>
                                <option value="止瀉藥">止瀉藥</option>
                                <option value="助眠藥">助眠藥</option>
                            </optgroup>
                            <optgroup label="中藥">
                                <option value="科學中藥">科學中藥</option>
                                <option value="水藥">水藥</option>
                            </optgroup>
                            <optgroup label="其他">
                                <option value="維他命">維他命</option>
                                <option value="保健食品">保健食品</option>
                                <option value="custom">自行輸入...</option>
                            </optgroup>
                        </select>
                        <input type="text" id="medicationName" class="large-input"
                               style="display: none; margin-top: 12px;"
                               placeholder="請輸入藥名">
                    </div>

                    <!-- 劑量和時機 -->
                    <div class="form-group-large">
                        <label for="dosage" class="large-label">
                            <span class="label-icon">💧</span>
                            <span>每次吃幾顆？</span>
                        </label>
                        <div class="dosage-quick-select">
                            <button type="button" class="dosage-btn" onclick="setDosage('1顆')">1顆</button>
                            <button type="button" class="dosage-btn" onclick="setDosage('2顆')">2顆</button>
                            <button type="button" class="dosage-btn" onclick="setDosage('3顆')">3顆</button>
                            <button type="button" class="dosage-btn" onclick="setDosage('半顆')">半顆</button>
                            <input type="text" id="dosage" class="large-input dosage-custom"
                                   placeholder="或自行輸入">
                        </div>
                    </div>

                    <div class="form-group-large">
                        <label for="mealTiming" class="large-label">
                            <span class="label-icon">🍚</span>
                            <span>什麼時候吃？</span>
                        </label>
                        <select id="mealTiming" class="large-select" required>
                            <option value="">請選擇</option>
                            <option value="before_meal">🍽️ 飯前吃（飯前30分鐘）</option>
                            <option value="with_meal">🍚 飯中吃（隨餐服用）</option>
                            <option value="after_meal">☕ 飯後吃（飯後30分鐘）</option>
                            <option value="anytime">⏰ 任何時間都可以</option>
                            <option value="bedtime">🌙 睡前吃</option>
                        </select>
                    </div>
                </div>

                <!-- 用藥類型選擇 -->
                <div class="form-section elder-form">
                    <h3 class="section-title">📅 用藥類型</h3>
                    <div class="medication-type-select">
                        <button type="button" class="type-option-btn active" data-type="chronic" onclick="selectMedicationType('chronic')">
                            <span class="type-icon">💊</span>
                            <span class="type-text">長期用藥</span>
                            <span class="type-desc">每天固定時間</span>
                        </button>
                        <button type="button" class="type-option-btn" data-type="shortterm" onclick="selectMedicationType('shortterm')">
                            <span class="type-icon">🤧</span>
                            <span class="type-text">短期用藥</span>
                            <span class="type-desc">吃幾天就好</span>
                        </button>
                    </div>
                    <input type="hidden" id="medicationDurationType" value="chronic">
                </div>

                <!-- 長期用藥時間設定 -->
                <div id="chronicTimeSettings" class="form-section elder-form">
                    <h3 class="section-title">⏰ 設定提醒時間</h3>

                    <!-- 快速時間選擇 -->
                    <div class="time-quick-select">
                        <h4 class="quick-select-title">常用時間：</h4>
                        <div class="time-preset-buttons">
                            <button type="button" class="time-preset-btn" onclick="addPresetTime('08:00')">
                                ☀️ 早上 8:00
                            </button>
                            <button type="button" class="time-preset-btn" onclick="addPresetTime('12:00')">
                                🌤️ 中午 12:00
                            </button>
                            <button type="button" class="time-preset-btn" onclick="addPresetTime('18:00')">
                                🌆 晚上 6:00
                            </button>
                            <button type="button" class="time-preset-btn" onclick="addPresetTime('21:00')">
                                🌙 睡前 9:00
                            </button>
                        </div>
                    </div>

                    <!-- 已選擇的時間 -->
                    <div id="reminderTimesContainer" class="selected-times-container">
                        <div class="time-input-group-large">
                            <label class="time-label">提醒時間：</label>
                            <input type="time" class="reminder-time large-time-input" required>
                            <button type="button" class="btn-icon-large danger" onclick="removeReminderTime(this)" style="display: none;">
                                ❌ 刪除
                            </button>
                        </div>
                    </div>

                    <button type="button" class="btn-secondary btn-large" onclick="addReminderTimeInForm()">
                        ➕ 新增其他時間
                    </button>

                    <p class="help-text-large">💡 提示：可以設定多個提醒時間</p>
                </div>

                <!-- 短期用藥時間設定 (NEW - 使用預設時段) -->
                <div id="shorttermTimeSettings" class="form-section elder-form" style="display: none;">
                    <h3 class="section-title">⏰ 短期用藥設定</h3>

                    <!-- 用藥頻率 -->
                    <div class="form-group-large">
                        <label class="large-label">
                            <span class="label-icon">💊</span>
                            <span>一天吃幾次？</span>
                        </label>
                        <div class="frequency-select">
                            <button type="button" class="frequency-btn" data-frequency="2" onclick="setFrequency(2, this)">
                                一日兩次
                            </button>
                            <button type="button" class="frequency-btn active" data-frequency="3" onclick="setFrequency(3, this)">
                                一日三次
                            </button>
                            <button type="button" class="frequency-btn" data-frequency="4" onclick="setFrequency(4, this)">
                                一日四次
                            </button>
                        </div>
                        <input type="hidden" id="dosesPerDay" value="3">
                    </div>

                    <!-- 時段方案 -->
                    <div class="form-group-large">
                        <label class="large-label">
                            <span class="label-icon">🕐</span>
                            <span>選擇用藥時段</span>
                        </label>

                        <!-- 一日三次的方案 -->
                        <div id="plan-3-times" class="timing-plans">
                            <button type="button" class="timing-plan-btn active" data-plan="plan1" onclick="setTimingPlan('plan1', this)">
                                <div class="plan-header">方案一</div>
                                <div class="plan-times">08:00 · 12:00 · 17:00</div>
                                <div class="plan-desc">早餐 · 午餐 · 晚餐</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="plan2" onclick="setTimingPlan('plan2', this)">
                                <div class="plan-header">方案二</div>
                                <div class="plan-times">09:00 · 13:00 · 18:00</div>
                                <div class="plan-desc">早餐 · 午餐 · 晚餐</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="custom" onclick="setTimingPlan('custom', this)">
                                <div class="plan-header">✏️ 自訂時間</div>
                                <div class="plan-desc">自己設定時間</div>
                            </button>
                        </div>

                        <!-- 一日兩次的方案 -->
                        <div id="plan-2-times" class="timing-plans" style="display: none;">
                            <button type="button" class="timing-plan-btn active" data-plan="plan1" onclick="setTimingPlan('plan1', this)">
                                <div class="plan-header">方案一</div>
                                <div class="plan-times">08:00 · 18:00</div>
                                <div class="plan-desc">早餐 · 晚餐</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="plan2" onclick="setTimingPlan('plan2', this)">
                                <div class="plan-header">方案二</div>
                                <div class="plan-times">09:00 · 19:00</div>
                                <div class="plan-desc">早餐 · 晚餐</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="custom" onclick="setTimingPlan('custom', this)">
                                <div class="plan-header">✏️ 自訂時間</div>
                                <div class="plan-desc">自己設定時間</div>
                            </button>
                        </div>

                        <!-- 一日四次的方案 -->
                        <div id="plan-4-times" class="timing-plans" style="display: none;">
                            <button type="button" class="timing-plan-btn active" data-plan="plan1" onclick="setTimingPlan('plan1', this)">
                                <div class="plan-header">方案一</div>
                                <div class="plan-times">08:00 · 12:00 · 17:00 · 21:00</div>
                                <div class="plan-desc">早 · 午 · 晚 · 睡前</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="plan2" onclick="setTimingPlan('plan2', this)">
                                <div class="plan-header">方案二</div>
                                <div class="plan-times">09:00 · 13:00 · 18:00 · 22:00</div>
                                <div class="plan-desc">早 · 午 · 晚 · 睡前</div>
                            </button>
                            <button type="button" class="timing-plan-btn" data-plan="custom" onclick="setTimingPlan('custom', this)">
                                <div class="plan-header">✏️ 自訂時間</div>
                                <div class="plan-desc">自己設定時間</div>
                            </button>
                        </div>

                        <input type="hidden" id="timingPlan" value="plan1">
                    </div>

                    <!-- 自訂時間輸入 (只在選擇自訂時顯示) -->
                    <div id="customTimesInput" class="form-group-large" style="display: none;">
                        <label class="large-label">
                            <span class="label-icon">⏰</span>
                            <span>設定用藥時間</span>
                        </label>
                        <div id="customTimesList" class="custom-times-list">
                            <div class="custom-time-input">
                                <span class="time-label">第 1 次：</span>
                                <input type="time" class="custom-time-field" value="08:00">
                            </div>
                            <div class="custom-time-input">
                                <span class="time-label">第 2 次：</span>
                                <input type="time" class="custom-time-field" value="13:00">
                            </div>
                            <div class="custom-time-input">
                                <span class="time-label">第 3 次：</span>
                                <input type="time" class="custom-time-field" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- 療程天數 -->
                    <div class="form-group-large">
                        <label class="large-label">
                            <span class="label-icon">📆</span>
                            <span>要吃幾天？</span>
                        </label>
                        <div class="duration-quick-select">
                            <button type="button" class="duration-btn active" onclick="setDuration(3, this)">3天</button>
                            <button type="button" class="duration-btn" onclick="setDuration(5, this)">5天</button>
                            <button type="button" class="duration-btn" onclick="setDuration(7, this)">7天</button>
                            <button type="button" class="duration-btn" onclick="setDuration(14, this)">14天</button>
                            <input type="number" id="treatmentDays" class="large-input"
                                   placeholder="或輸入天數" min="1" max="90" value="3" style="margin-top: 12px;">
                        </div>
                    </div>

                    <!-- 開始日期 -->
                    <div class="form-group-large">
                        <label class="large-label">
                            <span class="label-icon">📅</span>
                            <span>什麼時候開始吃？</span>
                        </label>
                        <div class="start-date-select">
                            <button type="button" class="start-date-btn active" onclick="setStartDate('today', this)">
                                今天開始
                            </button>
                            <button type="button" class="start-date-btn" onclick="setStartDate('tomorrow', this)">
                                明天開始
                            </button>
                            <button type="button" class="start-date-btn" onclick="setStartDate('custom', this)">
                                自選日期
                            </button>
                        </div>
                        <input type="date" id="startDateInput" class="large-input" style="display: none; margin-top: 12px;">
                        <input type="hidden" id="startDate" value="today">
                    </div>

                    <!-- 是否為抗生素 -->
                    <div class="form-group-large">
                        <label class="large-label">
                            <span class="label-icon">💉</span>
                            <span>是否為抗生素？</span>
                        </label>
                        <div class="antibiotic-select">
                            <button type="button" class="antibiotic-btn" data-value="yes" onclick="setAntibiotic('yes', this)">
                                ✅ 是抗生素
                            </button>
                            <button type="button" class="antibiotic-btn active" data-value="no" onclick="setAntibiotic('no', this)">
                                ❌ 不是
                            </button>
                        </div>
                        <input type="hidden" id="isAntibiotic" value="no">
                        <p class="help-text-large" id="antibioticWarning" style="display: none; color: #d97706; margin-top: 8px;">
                            ⚠️ 抗生素需要嚴格按時服用，將使用每隔固定小時的排程
                        </p>
                    </div>

                    <!-- 預覽按鈕 -->
                    <button type="button" class="preview-schedule-btn" onclick="previewShortTermSchedule()">
                        👁️ 預覽 3 天用藥計畫
                    </button>
                </div>

                <!-- 藥物照片上傳 (NEW) -->
                <div class="form-section elder-form">
                    <h3 class="section-title">📷 藥物照片（選填）</h3>
                    <div id="medicationImageUploader"></div>
                    <div id="existingMedicationImages" class="existing-images-container" style="display: none;">
                        <!-- 現有圖片會顯示在這裡 -->
                    </div>
                    <p class="help-text-large">💡 提示：可以拍攝藥物外觀或藥袋，方便辨識</p>
                </div>

                <!-- 進階設定 (選填，可展開) -->
                <div class="form-section collapsible">
                    <h3 onclick="toggleSection(this)">
                        🔽 進階設定（選填）
                    </h3>
                    <div class="collapsible-content" style="display: none;">
                        <div class="form-group">
                            <label for="medicationType">藥物類型</label>
                            <select id="medicationType">
                                <option value="">請選擇</option>
                                <option value="tablet">藥片/錠劑</option>
                                <option value="capsule">膠囊</option>
                                <option value="liquid">藥水/糖漿</option>
                                <option value="injection">注射劑</option>
                                <option value="topical">外用藥</option>
                                <option value="antibiotic">抗生素</option>
                            </select>
                        </div>

                        <div class="form-group" id="antibioticDaysGroup" style="display: none;">
                            <label for="antibioticDays">抗生素療程天數</label>
                            <input type="number" id="antibioticDays" min="1" max="30" placeholder="例如：7">
                            <small>⚠️ 抗生素需按時服用完整療程</small>
                        </div>

                        <div class="form-group">
                            <label for="purpose">用藥目的</label>
                            <input type="text" id="purpose" placeholder="例如：降血壓、控制血糖">
                        </div>

                        <div class="form-group">
                            <label for="instructions">服用說明</label>
                            <textarea id="instructions" rows="2" placeholder="例如：配溫開水服用、需要整顆吞服"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="sideEffects">可能副作用</label>
                            <textarea id="sideEffects" rows="2" placeholder="例如：可能會頭暈、嗜睡"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="prescribingDoctor">處方醫師</label>
                                <input type="text" id="prescribingDoctor" placeholder="例如：王大明醫師">
                            </div>
                            <div class="form-group">
                                <label for="stockQuantity">藥物庫存</label>
                                <input type="number" id="stockQuantity" value="30" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="medicationId">

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeMedicationModal()">
                        取消
                    </button>
                    <button type="submit" class="btn-primary">
                        💾 儲存並啟用提醒
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 提醒設定 Modal -->
    <div id="reminderModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>⏰ 提醒設定</h2>
                <button class="modal-close" onclick="closeReminderModal()">&times;</button>
            </div>
            <div id="reminderContent">
                <!-- 動態載入 -->
            </div>
        </div>
    </div>

    <!-- 手機鬧鐘設定 Modal -->
    <div id="phoneAlarmModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>📱 設定手機鬧鐘</h2>
                <button class="modal-close" onclick="closePhoneAlarmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alarm-intro">
                    <p style="font-size: 16px; color: #555; line-height: 1.8;">
                        以下是今日的用藥時間，點擊「設定鬧鐘」按鈕，系統會自動開啟手機的鬧鐘設定。
                    </p>
                </div>
                <div id="alarmListContent" class="alarm-list">
                    <!-- 動態載入鬧鐘列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Email 設定 Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📧 Email 通知設定</h2>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <form id="emailForm" onsubmit="saveEmailSettings(event)">
                <div class="form-group">
                    <label for="userEmail">Email 地址</label>
                    <input type="email" id="userEmail" placeholder="your.email@example.com">
                    <small>設定後將會收到用藥提醒郵件</small>
                </div>

                <div class="form-group">
                    <button type="button" class="btn-secondary" onclick="testEmail()">
                        📧 發送測試郵件
                    </button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEmailModal()">
                        取消
                    </button>
                    <button type="submit" class="btn-primary">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <!-- Scripts (按順序載入) -->
    <!-- 1. 全域配置 (最優先) -->
    <script src="config.js"></script>

    <!-- 2. Firebase 配置 -->
    <script src="firebase-config.js"></script>

    <!-- 3. 裝置偵測 -->
    <script src="device-detector.js"></script>

    <!-- 4. 圖片上傳元件 -->
    <script src="components/ImageUploader.js"></script>

    <!-- 5. 主要功能腳本 -->
    <script src="medications.js"></script>

    <!-- Service Worker 註冊 -->
    <script>
        // 註冊 Firebase Messaging Service Worker（用於推送通知）
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log('✅ Firebase Messaging SW 註冊成功:', registration.scope);
                })
                .catch((error) => {
                    console.error('❌ Firebase Messaging SW 註冊失敗:', error);
                });
        }
    </script>
</body>
</html>
